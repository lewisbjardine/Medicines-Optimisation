<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home / Ambulatory BP calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<style>
main{max-width:900px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
textarea{width:100%;box-sizing:border-box}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0}
.status{font-size:.85rem;margin:.4rem 0}
table{width:100%;border-collapse:collapse;margin-top:1rem}
th,td{border:1px solid #ddd;padding:.4rem;text-align:center}
th{background:#f6f6f6}
details{margin-top:1rem}
</style>
</head>

<body>
<header>
  <h1>Home / Ambulatory BP calculator</h1>
  <p class="subtitle">Paste readings or upload a photo. Please check values before calculating.</p>
  <a href="index.html" class="return-home">Back to Hypertension module</a>
</header>

<main>

<label><strong>Upload BP image (optional)</strong></label>
<input type="file" id="bpImage" accept="image/*">
<button id="aiInterpretBtn" class="secondary">Interpret image with AI</button>
<div class="status" id="imageStatus"></div>

<label style="margin-top:1rem;"><strong>BP readings (single source of truth)</strong></label>
<textarea id="bpText" rows="6" placeholder="135/78
140/82
132/76"></textarea>

<div class="actions">
  <button id="calcBtn">Calculate mean</button>
  <button id="useBtn" class="secondary" disabled>Use mean BP</button>
</div>

<div class="status">
  <strong>Mean BP:</strong> <span id="meanOut">–</span>
</div>

<details>
  <summary><strong>Optional NICE AHBPM review table (manual only)</strong></summary>
  <table>
    <thead>
      <tr><th>Day</th><th>AM 1</th><th>AM 2</th><th>PM 1</th><th>PM 2</th></tr>
    </thead>
    <tbody>
      <tr><td>1</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>2</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>3</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>4</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>5</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>6</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>7</td><td></td><td></td><td></td><td></td></tr>
    </tbody>
  </table>
</details>

</main>

<script>
const GEMINI_API_KEY = "PASTE_YOUR_GEMINI_API_KEY_HERE";
const GEMINI_MODEL = "gemini-1.5-flash";

const GEMINI_PROMPT = `Extract blood pressure readings from this image.
Return only systolic/diastolic pairs, one per line, e.g.
135/78`;

function parsePairs(text){
  const rx=/(\d{2,3})\s*\/\s*(\d{2,3})/g;
  const out=[]; let m;
  while((m=rx.exec(text))!==null){
    const s=+m[1], d=+m[2];
    if(s>=90&&s<=250&&d>=50&&d<=150) out.push({s,d});
  }
  return out;
}

function fileToBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

async function interpretImageWithGemini(file){
  const b64=await fileToBase64(file);
  const res=await fetch(
    `https://generativelanguage.googleapis.com/v1/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        contents:[{
          role:"user",
          parts:[
            {text:GEMINI_PROMPT},
            {inline_data:{mime_type:file.type,data:b64}}
          ]
        }]
      })
    }
  );
  if(!res.ok) throw new Error(await res.text());
  const j=await res.json();
  return j.candidates?.[0]?.content?.parts?.[0]?.text?.trim()||"";
}

const bpText=document.getElementById("bpText");
const meanOut=document.getElementById("meanOut");
const useBtn=document.getElementById("useBtn");
const imageStatus=document.getElementById("imageStatus");

document.getElementById("calcBtn").onclick=()=>{
  const v=parsePairs(bpText.value);
  if(!v.length){ meanOut.textContent="–"; useBtn.disabled=true; return; }
  const ms=Math.round(v.reduce((a,x)=>a+x.s,0)/v.length);
  const md=Math.round(v.reduce((a,x)=>a+x.d,0)/v.length);
  meanOut.textContent=`${ms}/${md} mmHg (n=${v.length})`;
  useBtn.dataset.bp=`${ms}/${md}`;
  useBtn.disabled=false;
};

useBtn.onclick=()=>{
  sessionStorage.setItem("hypertension_bp_value",useBtn.dataset.bp);
  sessionStorage.setItem("hypertension_bp_type","home");
  window.location.href="index.html";
};

document.getElementById("aiInterpretBtn").onclick=async()=>{
  const f=document.getElementById("bpImage").files[0];
  if(!f){ alert("Select an image first"); return; }
  imageStatus.textContent="Interpreting image with AI…";
  try{
    const t=await interpretImageWithGemini(f);
    bpText.value=bpText.value.trim()?bpText.value.trim()+"\n"+t:t;
    imageStatus.textContent="AI extracted BP readings. Please check.";
  }catch(e){
    console.error(e);
    imageStatus.textContent="AI interpretation failed.";
  }
};
</script>

</body>
</html>
