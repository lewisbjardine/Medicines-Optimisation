<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Opioid Conversion</title>
<link rel="stylesheet" href="../shared/styles.css">
<style>
.modal {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); justify-content:center; align-items:center;
}
.modal-content {
  background:#fff; padding:20px; border-radius:6px; max-width:400px;
}
</style>
</head>
<body>
<header>
<h1>Opioid conversion & breakthrough dosing</h1>
<p class="subtitle">BNF‑aligned opioid switching tool</p>
<a class="return-home" href="../index.html">Back to Medicines Optimisation home</a>
</header>

<main>
<div>
<h2>Current opioids</h2>
<div id="opioidRows"></div>
<button id="addOP">Add opioid</button>
</div>

<h2>Target opioid</h2>
<select id="targetOp">
<option value="bupe">Buprenorphine patch</option>
<option value="fent">Fentanyl patch</option>
</select>
<button id="calcBtn">Calculate</button>

<h2>Outputs</h2>
<div id="targetOutput"></div>
<textarea id="clinicianNote" style="width:100%;height:120px;"></textarea>
</main>

<!-- Modal -->
<div class="modal" id="doseModal">
  <div class="modal-content">
    <h3>Choose dose</h3>
    <div id="modalOptions"></div>
    <button id="modalConfirm">Confirm</button>
    <button id="modalCancel">Cancel</button>
  </div>
</div>

<script>
function bupeOptions(adj){
  const table=[
    {omed:12,str:5,label:"5 mcg/hr (7‑day)"},
    {omed:24,str:10,label:"10 mcg/hr (7‑day)"},
    {omed:36,str:15,label:"15 mcg/hr (7‑day)"},
    {omed:48,str:20,label:"20 mcg/hr (7‑day)"},
    {omed:84,str:35,label:"35 mcg/hr (4‑day)"},
    {omed:126,str:52.5,label:"52.5 mcg/hr (4‑day)"},
    {omed:168,str:70,label:"70 mcg/hr (4‑day)"}
  ];
  let best=table.reduce((a,b)=>Math.abs(b.omed-adj)<Math.abs(a.omed-adj)?b:a);
  let alts=table.filter(x=>x!==best && Math.abs(x.omed-adj)/adj<=0.3);
  return [best, ...alts];
}

function fentOptions(adj){
  const table=[
    {min:30,max:60,str:12},
    {min:60,max:90,str:25},
    {min:90,max:120,str:37},
    {min:120,max:180,str:50},
    {min:180,max:240,str:62},
    {min:240,max:300,str:75},
    {min:300,max:360,str:87},
    {min:360,max:9999,str:100}
  ];
  const row=table.find(r=>adj>=r.min && adj<r.max);
  if(!row) return [];
  // possible alternatives: neighbours
  let opts=[row];
  let idx=table.indexOf(row);
  if(idx>0) opts.push(table[idx-1]);
  if(idx<table.length-1) opts.push(table[idx+1]);
  return opts;
}

function openModal(options, callback){
  const modal=document.getElementById("doseModal");
  const box=document.getElementById("modalOptions");
  box.innerHTML="";
  options.forEach((o,i)=>{
    let id="opt"+i;
    box.innerHTML+=`<label><input type="radio" name="dosePick" value="${o.str}" id="${id}"> ${o.str} mcg/hr</label><br>`;
  });
  modal.style.display="flex";
  document.getElementById("modalConfirm").onclick=function(){
    let v=document.querySelector("input[name='dosePick']:checked");
    if(!v) return;
    modal.style.display="none";
    callback(v.value);
  };
  document.getElementById("modalCancel").onclick=function(){
    modal.style.display="none";
  };
}

document.getElementById("calcBtn").onclick=function(){
  let adj=150; // simulate OMED calc placeholder
  let target=document.getElementById("targetOp").value;
  let opts=(target==="bupe")?bupeOptions(adj):fentOptions(adj);
  if(opts.length>1){
    openModal(opts, function(choice){
      document.getElementById("targetOutput").innerHTML="Chosen dose: "+choice+" mcg/hr";
      document.getElementById("clinicianNote").value="Chosen "+choice+" mcg/hr patch. OMED="+adj;
    });
  } else if(opts.length===1){
    let c=opts[0].str;
    document.getElementById("targetOutput").innerHTML="Suggested dose: "+c+" mcg/hr";
  } else {
    document.getElementById("targetOutput").innerHTML="No valid dose.";
  }
};
</script>

</body>
</html>
