<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Opioid conversion & breakthrough dosing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../styles.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    main {
      max-width: 960px;
      margin: 1.5rem auto;
      padding: 1rem;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    h1, h2 {
      margin-top: 0;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    .opioid-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.9fr) auto;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: end;
    }
    .opioid-row label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.1rem;
    }
    .opioid-row select,
    .opioid-row input {
      width: 100%;
      box-sizing: border-box;
      padding: 0.3rem 0.4rem;
    }
    button {
      padding: 0.4rem 0.8rem;
      border-radius: 3px;
      border: 1px solid #005eb8;
      background: #005eb8;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.secondary {
      background: #fff;
      color: #005eb8;
    }
    button.primary:disabled {
      background: #999 !important;
      border-color: #777 !important;
      color: #eee !important;
      cursor: not-allowed;
    }
    button.small {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
    }
    .button-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1rem;
    }
    .output-box {
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 0.6rem;
      min-height: 3rem;
      white-space: pre-wrap;
      font-size: 0.9rem;
      background: #fafafa;
    }
    .output-box strong {
      font-weight: 600;
      color: #000;
    }
    .small-select {
      padding: 0.2rem 0.4rem;
      font-size: 0.85rem;
      margin: 0.2rem 0;
    }
    textarea {
      width: 100%;
      min-height: 7rem;
      box-sizing: border-box;
      resize: vertical;
      font-family: inherit;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Opioid conversion &amp; breakthrough dosing</h1>
    <p class="subtitle">
      Approximate opioid conversion helper for adult patients, based on SPS/BNF guidance.
      This does not replace clinical judgement; always check local palliative care guidelines.
    </p>
    <a href="../index.html" class="return-home">Back to Medicines Optimisation home</a>
  </header>

  <main>
    <section class="section">
      <h2>1. Current opioid use</h2>
      <p style="font-size:0.9rem;">Enter all regular opioids (24-hour totals). Include PRN doses if used frequently.</p>
      <div id="opioidRows"></div>
      <div class="button-row">
        <button type="button" id="addOpioidBtn">Add another opioid</button>
        <button type="button" id="clearOpioidsBtn" class="secondary">Clear all</button>
      </div>
    </section>

    <section class="section">
      <h2>2. Target opioid &amp; frailty</h2>
      <div class="opioid-row" style="grid-template-columns: minmax(0,1.4fr) minmax(0,0.9fr);">
        <div>
          <label for="targetOpioid">Target opioid</label>
          <select id="targetOpioid">
            <option value="oral_morphine">Oral morphine (24h total)</option>
            <option value="oral_oxycodone">Oral oxycodone (24h total)</option>
            <option value="fentanyl_patch">Fentanyl patch</option>
            <option value="transdermal_buprenorphine">Buprenorphine patch</option>
            <option value="sc_morphine">Morphine SC (24h syringe driver)</option>
            <option value="sc_diamorphine">Diamorphine SC (24h syringe driver)</option>
          </select>
        </div>
        <div>
          <label for="frailtyFactor">Dose reduction factor</label>
          <select id="frailtyFactor">
            <option value="1">None (fit adult)</option>
            <option value="0.75">Mild frailty / age &gt; 65</option>
            <option value="0.5">Significant frailty / high risk</option>
          </select>
        </div>
      </div>

      <div class="button-row" style="margin-top:0.75rem;">
        <button type="button" id="convertBtn" class="primary">Calculate conversion</button>
        <button type="button" id="clearOutputsBtn" class="secondary">Clear outputs</button>
      </div>
    </section>

    <section class="section">
      <h2>3. Outputs</h2>
      <div class="grid-3">
        <div>
          <strong>Total oral morphine equivalent (OMED)</strong>
          <div class="output-box" id="omedOutput"></div>
        </div>
        <div>
          <strong>Suggested target opioid regimen</strong>
          <div class="output-box" id="targetOutput"></div>
        </div>
        <div>
          <strong>Breakthrough / PRN opioid suggestion</strong><br />
          <label for="brForm" style="font-size:0.8rem;">Breakthrough formulation</label><br />
          <select id="brForm" class="small-select">
            <option value="oramorph">Oramorph (oral morphine IR)</option>
            <option value="sc_morphine">SC morphine</option>
            <option value="diamorphine">Diamorphine SC</option>
            <option value="oxynorm">Oxynorm (oxycodone IR)</option>
          </select>
          <div class="output-box" id="prnOutput"></div>
        </div>
      </div>

      <div style="margin-top:1rem;">
        <strong>Clinician note (EMIS/SystmOne)</strong>
        <button type="button" id="copyClinicianBtn" class="small secondary" style="float:right;">Copy</button>
        <div style="clear:both;"></div>
        <textarea id="clinicianNoteOutput" readonly></textarea>
      </div>
    </section>
  </main>

  <script>
    const opioidFactors = {
      oral_codeine: {
        toMorphine: dose => dose / 10,
        label: "Codeine (oral)"
      },
      oral_tramadol: {
        toMorphine: dose => dose / 10,
        label: "Tramadol (oral)"
      },
      oral_morphine: {
        toMorphine: dose => dose,
        label: "Morphine (oral)"
      },
      oral_oxycodone_ir: {
        toMorphine: dose => dose * 2,
        label: "Oxycodone IR (oral)"
      },
      oral_oxycodone_mr: {
        toMorphine: dose => dose * 2,
        label: "Oxycodone MR (oral)"
      },
      fentanyl_patch: {
        toMorphine: dose => dose * 3,
        label: "Fentanyl patch (mcg/hour)"
      },
      sc_morphine: {
        toMorphine: dose => dose * 2,
        label: "Morphine SC (24h)"
      },
      sc_diamorphine: {
        toMorphine: dose => dose * 3,
        label: "Diamorphine SC (24h)"
      }
    };

    const targetSuggestions = {
      oral_morphine: (omed, frailty) => {
        const adj = omed * frailty;
        const bd = Math.round(adj / 2 / 2.5) * 2.5;
        return `<strong>Approximate equivalent oral morphine: ${Math.round(adj)} mg/24h (e.g. ${bd} mg MR twice daily).</strong><br>
                Use available MR strengths; consider lower doses in frailty or renal impairment.`;
      },
      oral_oxycodone: (omed, frailty) => {
        const adj = omed * frailty;
        const oxy = adj / 2;
        const bd = Math.round(oxy / 2 / 2.5) * 2.5;
        return `<strong>Approximate equivalent oral oxycodone: ${Math.round(oxy)} mg/24h (e.g. ${bd} mg MR twice daily).</strong><br>
                Check BNF strengths (e.g. 5, 10, 20, 40 mg) and round down if concerned.`;
      },
      fentanyl_patch: (omed, frailty) => {
        const adj = omed * frailty;
        const fent = adj / 3;
        const strengths = [12, 25, 37, 50, 75, 100];
        const nearest = strengths.reduce((a, b) =>
          Math.abs(b - fent) < Math.abs(a - fent) ? b : a
        );
        return `<strong>Approximate fentanyl patch: ${nearest} micrograms/hour.</strong><br>
                Estimate based on ~${Math.round(fent)} micrograms/hour; available BNF strengths include 12, 25, 37, 50, 75, 100 mcg/h. Consider starting at a lower strength and titrating.`;
      },
      transdermal_buprenorphine: (omed, frailty) => {
        const adj = omed * frailty;
        const estimated = adj / 10;
        const patch7 = [5, 10, 15, 20];
        const patch4 = [35, 52.5, 70];
        const nearest = (list, val) =>
          list.reduce((a, b) =>
            Math.abs(b - val) < Math.abs(a - val) ? b : a
          );
        let choice, patchType;
        if (estimated <= 20) {
          choice = nearest(patch7, estimated);
          patchType = "7-day patch (e.g. BuTrans/Butec)";
        } else {
          choice = nearest(patch4, estimated);
          patchType = "4-day patch (e.g. Transtec)";
        }
        return `<strong>Approximate buprenorphine patch: ${choice} micrograms/hour, ${patchType}.</strong><br>
                Estimated requirement: ~${Math.round(estimated)} micrograms/hour from total OMED. Check BNF-licensed strengths and consider starting at a lower patch strength in frailty.`;
      },
      sc_morphine: (omed, frailty) => {
        const adj = omed * frailty;
        const sc = adj / 2;
        return `<strong>Approximate morphine SC (24h syringe driver): ${Math.round(sc)} mg/24h.</strong><br>
                Typically given via continuous SC infusion; adjust per local palliative care guidance.`;
      },
      sc_diamorphine: (omed, frailty) => {
        const adj = omed * frailty;
        const dia = adj / 3;
        return `<strong>Approximate diamorphine SC (24h syringe driver): ${Math.round(dia)} mg/24h.</strong><br>
                Consider lower starting doses in frailty or renal impairment; seek specialist advice if unsure.`;
      }
    };

    function clearOutputs() {
      document.getElementById("omedOutput").textContent = "";
      document.getElementById("targetOutput").textContent = "";
      document.getElementById("prnOutput").textContent = "";
      document.getElementById("clinicianNoteOutput").value = "";
    }

    function markDirty() {
      clearOutputs();
      const btn = document.getElementById("convertBtn");
      if (btn) btn.disabled = false;
    }

    function createOpioidRow() {
      const row = document.createElement("div");
      row.className = "opioid-row";
      row.innerHTML = `
        <div>
          <label>Opioid</label>
          <select class="opioid-select">
            <option value="oral_codeine">Codeine (mg/24h)</option>
            <option value="oral_tramadol">Tramadol (mg/24h)</option>
            <option value="oral_morphine">Morphine (oral, mg/24h)</option>
            <option value="oral_oxycodone_ir">Oxycodone IR (oral, mg/24h)</option>
            <option value="oral_oxycodone_mr">Oxycodone MR (oral, mg/24h)</option>
            <option value="fentanyl_patch">Fentanyl patch (mcg/hour)</option>
            <option value="sc_morphine">Morphine SC (mg/24h)</option>
            <option value="sc_diamorphine">Diamorphine SC (mg/24h)</option>
          </select>
        </div>
        <div>
          <label>Total daily dose</label>
          <input type="number" class="dose-input" min="0" step="1" />
        </div>
        <button type="button" class="remove-opioid-btn small secondary">Remove</button>
      `;
      row.querySelector(".remove-opioid-btn").addEventListener("click", () => {
        row.remove();
        markDirty();
      });
      const sel = row.querySelector(".opioid-select");
      const dose = row.querySelector(".dose-input");
      sel.addEventListener("change", markDirty);
      dose.addEventListener("input", markDirty);
      return row;
    }

    function addOpioidRow() {
      const container = document.getElementById("opioidRows");
      const row = createOpioidRow();
      container.appendChild(row);
      markDirty();
    }

    function clearOpioidRows() {
      const container = document.getElementById("opioidRows");
      container.innerHTML = "";
      addOpioidRow();
      markDirty();
    }

    function roundTo(value, step, min) {
      const rounded = Math.round(value / step) * step;
      return Math.max(min, rounded);
    }

    function calculate() {
      const rows = document.querySelectorAll(".opioid-row");
      let totalOmed = 0;
      const parts = [];

      rows.forEach(row => {
        const select = row.querySelector(".opioid-select");
        const doseInput = row.querySelector(".dose-input");
        if (!select || !doseInput) return;

        const key = select.value;
        const doseVal = parseFloat(doseInput.value);
        if (!doseVal || !opioidFactors[key]) return;

        const omed = opioidFactors[key].toMorphine(doseVal);
        totalOmed += omed;
        parts.push(`${opioidFactors[key].label}: ${doseVal} → ~${Math.round(omed)} mg OMED`);
      });

      const omedBox = document.getElementById("omedOutput");
      const targetBox = document.getElementById("targetOutput");
      const prnBox = document.getElementById("prnOutput");
      const noteBox = document.getElementById("clinicianNoteOutput");
      const brForm = document.getElementById("brForm");
      const convertBtn = document.getElementById("convertBtn");

      if (totalOmed === 0) {
        omedBox.textContent = "No valid doses entered.";
        targetBox.textContent = "";
        prnBox.textContent = "";
        noteBox.value = "";
        return;
      }

      const omedRounded = Math.round(totalOmed);
      omedBox.innerHTML =
        `<strong>Approximate total oral morphine equivalent: ${omedRounded} mg/24h.</strong><br>` +
        `(This is an estimate – check SPS/BNF guidance and consider dose reduction for frailty or co-morbidity.)`;

      const targetKey = document.getElementById("targetOpioid").value;
      const frailty = parseFloat(document.getElementById("frailtyFactor").value || "1");
      const suggestFn = targetSuggestions[targetKey];

      if (brForm) {
        if (targetKey === "sc_morphine") {
          brForm.value = "sc_morphine";
        } else if (targetKey === "sc_diamorphine") {
          brForm.value = "diamorphine";
        } else if (!brForm.value) {
          brForm.value = "oramorph";
        }
      }

      if (suggestFn) {
        const targetText = suggestFn(omedRounded, frailty) || "";
        targetBox.innerHTML = targetText.replace(/\n/g, "<br>");
      } else {
        targetBox.textContent = "Target opioid suggestion not available for this selection.";
      }

      let basePrn = (omedRounded * frailty) / 6;
      let prnDrug = "Morphine immediate-release (e.g. Oramorph)";
      let prnDose = basePrn;

      if (brForm) {
        const form = brForm.value || "oramorph";
        if (form === "sc_morphine") {
          prnDrug = "Morphine SC";
          prnDose = basePrn / 2;
        } else if (form === "diamorphine") {
          prnDrug = "Diamorphine SC";
          prnDose = basePrn / 3;
        } else if (form === "oxynorm") {
          prnDrug = "Oxycodone IR (Oxynorm)";
          prnDose = basePrn / 2;
        }
      }

      const isSC = /SC/.test(prnDrug);
      const roundedPrn = isSC ?
        Math.max(1, Math.round(prnDose)) :
        roundTo(prnDose, 2.5, 2.5);

      prnBox.innerHTML =
        `Suggested breakthrough dose based on adjusted OMED:<br>` +
        `<strong>• ${prnDrug}: ${roundedPrn} mg up to 4-hourly PRN.</strong><br>` +
        `Always check local palliative care guidance, especially in renal impairment or high baseline doses.`;

      const noteLines = [];
      noteLines.push(`Approximate total OMED: ~${omedRounded} mg/24h (estimate only).`);
      if (parts.length) {
        noteLines.push("Current opioids:");
        parts.forEach(p => noteLines.push(" - " + p));
      }
      noteLines.push(`Target opioid: ${document.getElementById("targetOpioid").selectedOptions[0].text}, with dose reduction factor ${frailty}.`);
      noteLines.push(`Breakthrough: ${prnDrug} approx ${roundedPrn} mg up to 4-hourly PRN (adjust for renal function, age, frailty and local guidance).`);
      noteLines.push("Plan discussed with patient; advised to report sedation, confusion, hallucinations, uncontrolled pain, or side-effects promptly. Consider specialist palliative care / pain advice if unstable or high dose.");

      noteBox.value = noteLines.join("\n");

      if (convertBtn) convertBtn.disabled = true;
    }

    function initOpioidTool() {
      const addBtn = document.getElementById("addOpioidBtn");
      const clearBtn = document.getElementById("clearOpioidsBtn");
      const convertBtn = document.getElementById("convertBtn");
      const clearOutputsBtn = document.getElementById("clearOutputsBtn");
      const copyBtn = document.getElementById("copyClinicianBtn");
      const targetSel = document.getElementById("targetOpioid");
      const frailtySel = document.getElementById("frailtyFactor");
      const brForm = document.getElementById("brForm");

      addBtn.addEventListener("click", addOpioidRow);
      clearBtn.addEventListener("click", clearOpioidRows);
      convertBtn.addEventListener("click", calculate);
      clearOutputsBtn.addEventListener("click", () => {
        clearOutputs();
        convertBtn.disabled = false;
      });
      copyBtn.addEventListener("click", () => {
        const note = document.getElementById("clinicianNoteOutput").value;
        if (!note) return;
        navigator.clipboard.writeText(note).then(() => {
          copyBtn.textContent = "Copied";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1500);
        }).catch(() => {});
      });

      targetSel.addEventListener("change", markDirty);
      frailtySel.addEventListener("change", markDirty);
      brForm.addEventListener("change", markDirty);

      clearOpioidRows();
      convertBtn.disabled = false;
    }

    window.addEventListener("DOMContentLoaded", initOpioidTool);
  </script>
</body>
</html>
