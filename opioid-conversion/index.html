<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Opioid conversion & breakthrough dosing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Use shared NHS branding styles -->
  <link rel="stylesheet" href="../shared/styles.css" />
  <style>
/* patched */
</style>
</head>
<body>
  <header>
    <h1>Opioid conversion &amp; breakthrough dosing</h1>
    <p class="subtitle">
      Approximate opioid conversion helper for adults, using UK BNF-aligned palliative-care tables.
      Does not replace local guidelines or specialist advice.
    </p>
    <a href="../index.html" class="return-home">Back to Medicines Optimisation home</a>
  </header>

  <main>
    <section class="section">
      <h2>1. Current opioid use</h2>
      <p style="font-size:0.9rem;">
        Enter all regular opioids (24-hour totals). Include frequent PRN doses if clinically relevant.
      </p>
      <div id="opioidRows"></div>
      <div class="button-row">
        <button type="button" id="addOpioidBtn" class="primary">Add another opioid</button>
        <button type="button" id="clearOpioidsBtn" class="secondary">Clear all</button>
      </div>
    </section>

    <section class="section">
      <h2>2. Target opioid &amp; frailty</h2>
      <div class="opioid-row" style="grid-template-columns: 0.8fr 1fr auto;">
        <div>
          <label for="targetOpioid">Target opioid</label>
          <select id="targetOpioid">
            <option value="oral_morphine">Oral morphine (24h total)</option>
            <option value="oral_oxycodone">Oral oxycodone (24h total)</option>
            <option value="fentanyl_patch">Fentanyl patch</option>
            <option value="buprenorphine_patch">Buprenorphine patch</option>
            <option value="sc_morphine">Morphine SC (24h syringe driver)</option>
            <option value="sc_diamorphine">Diamorphine SC (24h syringe driver)</option>
          </select>
        </div>
        <div>
          <label for="frailtyFactor">Dose reduction factor (required)</label>
          <select id="frailtyFactor">
            <option value="" disabled selected>-- Select dose reduction factor --</option>
            <option value="1">None (fit adult)</option>
            <option value="0.75">Mild frailty / age &gt; 65</option>
            <option value="0.5">Significant frailty / high risk</option>
          </select>
          <div id="frailtyError" class="error-text">Please select a dose reduction factor.</div>
        </div>
        <div>
          <button type="button" id="convertBtn" class="primary" disabled>Calculate conversion</button>
        </div>
      </div>

    </section>

    <section class="section">
      <h2>3. Outputs</h2>
      <div class="output-grid">
        <div class="output-card">
          <div class="output-header">
            <strong>Total oral morphine equivalent (OMED)</strong>
          </div>
          <div class="output-body">
            <div class="output-box" id="omedOutput"></div>
          </div>
        </div>
        <div class="output-card">
          <div class="output-header">
            <strong>Suggested target opioid regimen</strong>
          </div>
          <div class="output-body">
            <div class="output-box" id="targetOutput"></div>
          </div>
        </div>
        <div class="output-card">
          <div class="output-header">
            <strong>Breakthrough / PRN opioid suggestion</strong>
          </div>
          <div class="output-body">
            <div class="prn-wrapper"><label for="brForm" style="font-size:0.8rem;">Breakthrough formulation</label>
  <select id="brForm" class="small-select">
              <option value="oramorph">Oramorph (oral morphine IR)</option>
              <option value="sc_morphine">SC morphine</option>
              <option value="diamorphine">Diamorphine SC</option>
              <option value="oxynorm">Oxynorm (oxycodone IR)</option>
            </select>
            </div>
<div class="output-box" id="prnOutput"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:1rem;">
        <strong>Clinician note (EMIS/SystmOne)</strong>
        <button type="button" id="copyClinicianBtn" class="small secondary" style="float:right;">Copy</button>
        <div style="clear:both;"></div>
        <textarea id="clinicianNoteOutput" readonly></textarea>
      </div>

      <div class="button-row" style="margin-top:0.75rem;">
        <button type="button" id="clearOutputsBtn" class="secondary">Clear outputs</button>
      </div>
    </section>
  </main>

  <!-- Dose selection modal -->
  <div class="modal-backdrop" id="doseModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="doseModalTitle">
      <h2 id="doseModalTitle">Choose target opioid dose</h2>
      <p id="doseModalExplanation" style="font-size:0.9rem;"></p>
      <div class="modal-options" id="doseModalOptions"></div>
      <div class="modal-actions">
        <button type="button" id="doseModalCancel" class="secondary">Cancel</button>
        <button type="button" id="doseModalConfirm" class="primary" disabled>Confirm choice</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Conversion tables =====
    const opioidFactors = {
      oral_codeine: {
        toMorphine: dose => dose * 0.1,
        label: "Codeine (oral)",
        factor: 0.1
      },
      oral_tramadol: {
        toMorphine: dose => dose * 0.1,
        label: "Tramadol (oral)",
        factor: 0.1
      },
      oral_morphine: {
        toMorphine: dose => dose,
        label: "Morphine (oral)",
        factor: 1
      },
      oral_oxycodone_ir: {
        toMorphine: dose => dose * 1.5,
        label: "Oxycodone IR (oral)",
        factor: 1.5
      },
      oral_oxycodone_mr: {
        toMorphine: dose => dose * 1.5,
        label: "Oxycodone MR (oral)",
        factor: 1.5
      },
      fentanyl_patch: {
        toMorphine: dose => dose * 2.4,
        label: "Fentanyl patch (mcg/hour)",
        factor: 2.4
      },
      sc_morphine: {
        toMorphine: dose => dose * 2,
        label: "Morphine SC (24h)",
        factor: 2
      },
      sc_diamorphine: {
        toMorphine: dose => dose * 3,
        label: "Diamorphine SC (24h)",
        factor: 3
      }
    };

    // Buprenorphine patch approximate OMED bands
    const buprenorphineTable = [
      { omed: 12,  strength: 5,    freq: "every 7 days",   label: "5 mcg/hour (BuTrans/Butec 7-day)" },
      { omed: 24,  strength: 10,   freq: "every 7 days",   label: "10 mcg/hour (7-day)" },
      { omed: 36,  strength: 15,   freq: "every 7 days",   label: "15 mcg/hour (7-day)" },
      { omed: 48,  strength: 20,   freq: "every 7 days",   label: "20 mcg/hour (7-day)" },
      { omed: 84,  strength: 35,   freq: "every 3–4 days", label: "35 mcg/hour (Transtec 4-day)" },
      { omed: 126, strength: 52.5, freq: "every 3–4 days", label: "52.5 mcg/hour (4-day)" },
      { omed: 168, strength: 70,   freq: "every 3–4 days", label: "70 mcg/hour (4-day)" }
    ];

    // Fentanyl patch bands
    const fentanylTable = [
      { min: 30,  max: 60,  strength: 12,  label: "12 mcg/hour (72-hour)" },
      { min: 60,  max: 90,  strength: 25,  label: "25 mcg/hour (72-hour)" },
      { min: 90,  max: 120, strength: 37,  label: "37 mcg/hour (72-hour)" },
      { min: 120, max: 180, strength: 50,  label: "50 mcg/hour (72-hour)" },
      { min: 180, max: 240, strength: 62,  label: "62 mcg/hour (72-hour)" },
      { min: 240, max: 300, strength: 75,  label: "75 mcg/hour (72-hour)" },
      { min: 300, max: 360, strength: 87,  label: "87 mcg/hour (72-hour)" },
      { min: 360, max: Infinity, strength: 100, label: "100 mcg/hour (72-hour)" }
    ];

    function roundTo(value, step, min) {
      const rounded = Math.round(value / step) * step;
      return Math.max(min, rounded);
    }

    function isFrailtyValid() {
      const frailtySelect = document.getElementById("frailtyFactor");
      return frailtySelect && frailtySelect.value !== "";
    }

    // ===== DOM helpers =====
    function clearOutputs() {
      document.getElementById("omedOutput").textContent = "";
      document.getElementById("targetOutput").textContent = "";
      document.getElementById("prnOutput").textContent = "";
      document.getElementById("clinicianNoteOutput").value = "";
    }

    function markDirty() {
      clearOutputs();
      const btn = document.getElementById("convertBtn");
      const errorEl = document.getElementById("frailtyError");
      if (errorEl) errorEl.style.display = "none";
      if (btn) {
        btn.disabled = !isFrailtyValid();
      }
    }

    function createOpioidRow() {
      const row = document.createElement("div");
      row.className = "opioid-row";
      row.innerHTML = `
        <div>
          <label>Opioid</label>
          <select class="opioid-select">
            <option value="oral_codeine">Codeine (mg/24h)</option>
            <option value="oral_tramadol">Tramadol (mg/24h)</option>
            <option value="oral_morphine">Morphine (oral, mg/24h)</option>
            <option value="oral_oxycodone_ir">Oxycodone IR (oral, mg/24h)</option>
            <option value="oral_oxycodone_mr">Oxycodone MR (oral, mg/24h)</option>
            <option value="fentanyl_patch">Fentanyl patch (mcg/hour)</option>
            <option value="sc_morphine">Morphine SC (mg/24h)</option>
            <option value="sc_diamorphine">Diamorphine SC (mg/24h)</option>
          </select>
        </div>
        <div>
          <label>Total daily dose</label>
          <input type="number" class="dose-input" min="0" step="1" />
        </div>
        <button type="button" class="remove-opioid-btn secondary small">Remove</button>
      `;
      row.querySelector(".remove-opioid-btn").addEventListener("click", () => {
        row.remove();
        markDirty();
      });
      const sel = row.querySelector(".opioid-select");
      const dose = row.querySelector(".dose-input");
      sel.addEventListener("change", markDirty);
      dose.addEventListener("input", markDirty);
      return row;
    }

    function addOpioidRow() {
      const container = document.getElementById("opioidRows");
      const row = createOpioidRow();
      container.appendChild(row);
      markDirty();
    }

    function clearOpioidRows() {
      const container = document.getElementById("opioidRows");
      container.innerHTML = "";
      addOpioidRow();
      markDirty();
    }

    // ===== Modal handling =====
    let pendingCalcContext = null;

    function openDoseChoiceModal(context, options, explanation) {
      pendingCalcContext = { ...context, options };
      const backdrop = document.getElementById("doseModalBackdrop");
      const optionsContainer = document.getElementById("doseModalOptions");
      const explanationEl = document.getElementById("doseModalExplanation");
      const confirmBtn = document.getElementById("doseModalConfirm");

      explanationEl.textContent = explanation;
      optionsContainer.innerHTML = "";
      confirmBtn.disabled = true;

      options.forEach((opt, index) => {
        const id = "doseChoice_" + index;
        const wrapper = document.createElement("label");
        wrapper.htmlFor = id;
        if (index === 0) {
          wrapper.classList.add("closest-option");
          wrapper.innerHTML =
            '<input type="radio" name="doseChoice" id="' + id + '" value="' + index + '"> ' +
            opt.label + " – covers approximately " + opt.omedText +
            '<div class="closest-tag">Closest match to adjusted OMED</div>';
        } else {
          wrapper.innerHTML =
            '<input type="radio" name="doseChoice" id="' + id + '" value="' + index + '"> ' +
            opt.label + " – covers approximately " + opt.omedText;
        }
        optionsContainer.appendChild(wrapper);
      });

      optionsContainer.addEventListener("change", function onChange(ev) {
        if (ev.target && ev.target.name === "doseChoice") {
          confirmBtn.disabled = false;
        }
      }, { once: true });

      backdrop.classList.add("active");
    }

    function closeDoseChoiceModal() {
      const backdrop = document.getElementById("doseModalBackdrop");
      backdrop.classList.remove("active");
      pendingCalcContext = null;
    }

    function handleDoseChoiceConfirm() {
      const selected = document.querySelector("input[name='doseChoice']:checked");
      if (!selected || !pendingCalcContext) return;
      const index = parseInt(selected.value, 10);
      const opt = pendingCalcContext.options[index];
      finaliseOutputsWithChoice(pendingCalcContext, opt);
      const convertBtn = document.getElementById("convertBtn");
      if (convertBtn) convertBtn.disabled = true;
      closeDoseChoiceModal();
    }

    function handleDoseChoiceCancel() {
      closeDoseChoiceModal();
      clearOutputs();
      markDirty();
    }

    // ===== Target suggestion helpers =====

    function getBuprenorphineOptions(adjOMED) {
      const maxSingle = Math.max(...buprenorphineTable.map(row => row.omed));
      const options = [];

      if (adjOMED <= maxSingle) {
        // Single patch range: nearest + neighbours within ±30%
        let nearest = buprenorphineTable.reduce((best, row) =>
          Math.abs(row.omed - adjOMED) < Math.abs(best.omed - adjOMED) ? row : best
        );
        const singles = [nearest];
        buprenorphineTable.forEach(row => {
          if (row !== nearest && Math.abs(row.omed - adjOMED) / adjOMED <= 0.3) {
            singles.push(row);
          }
        });
        singles.forEach(row => {
          options.push({
            type: "single",
            strength: row.strength,
            freq: row.freq,
            label: row.label,
            omed: row.omed,
            omedText: row.omed + " mg/24h oral morphine"
          });
        });
        // sort singles by closeness (nearest first)
        options.sort((a, b) => Math.abs(a.omed - adjOMED) - Math.abs(b.omed - adjOMED));
        return options;
      }

      // Above single patch range – combos of two patches with same frequency
      const byFreq = buprenorphineTable.reduce((acc, row) => {
        acc[row.freq] = acc[row.freq] || [];
        acc[row.freq].push(row);
        return acc;
      }, {});

      Object.keys(byFreq).forEach(freq => {
        const arr = byFreq[freq];
        for (let i = 0; i < arr.length; i++) {
          for (let j = i; j < arr.length; j++) {
            const a = arr[i];
            const b = arr[j];
            const totalOmed = a.omed + b.omed;
            const totalStrength = a.strength + b.strength;
            if (totalOmed >= adjOMED * 0.5 && totalOmed <= adjOMED * 1.5) {
              options.push({
                type: "combo",
                strength: totalStrength,
                freq: freq,
                label: a.strength + " + " + b.strength + " micrograms/hour (" + freq + ")",
                omed: totalOmed,
                omedText: "≈ " + totalOmed + " mg/24h oral morphine"
              });
            }
          }
        }
      });

      if (!options.length) {
        const maxRow = buprenorphineTable[buprenorphineTable.length - 1];
        options.push({
          type: "single",
          strength: maxRow.strength,
          freq: maxRow.freq,
          label: maxRow.label,
          omed: maxRow.omed,
          omedText: maxRow.omed + " mg/24h oral morphine"
        });
      }

      options.sort((a, b) => Math.abs(a.omed - adjOMED) - Math.abs(b.omed - adjOMED));
      return options;
    }

    function getFentanylOptions(adjOMED) {
      const options = [];
      // Single patch banding up to ~360 mg
      const main = fentanylTable.find(row => adjOMED >= row.min && adjOMED < row.max);
      if (main && adjOMED <= 360) {
        const idx = fentanylTable.indexOf(main);
        const neighbours = [];
        if (idx > 0) neighbours.push(fentanylTable[idx - 1]);
        if (idx < fentanylTable.length - 1) neighbours.push(fentanylTable[idx + 1]);
        const all = [main, ...neighbours];
        all.forEach(row => {
          const mid = row.max === Infinity ? row.min : (row.min + row.max) / 2;
          options.push({
            type: "single",
            strength: row.strength,
            label: row.label,
            omed: mid,
            omedText: row.max === Infinity
              ? "≥ " + row.min + " mg/24h oral morphine"
              : row.min + "–" + row.max + " mg/24h oral morphine"
          });
        });
        options.sort((a, b) => Math.abs(a.omed - adjOMED) - Math.abs(b.omed - adjOMED));
        return options;
      }

      // Higher ranges – combinations of two patches
      const strengths = [12, 25, 37, 50, 62, 75, 87, 100];
      const potencyPerMcg = 2.4; // 1 mcg/hour ≈ 2.4 mg OMED

      for (let i = 0; i < strengths.length; i++) {
        for (let j = i; j < strengths.length; j++) {
          const s1 = strengths[i];
          const s2 = strengths[j];
          const totalStrength = s1 + s2;
          const totalOmed = totalStrength * potencyPerMcg;
          if (totalOmed >= adjOMED * 0.5 && totalOmed <= adjOMED * 1.5) {
            options.push({
              type: "combo",
              strength: totalStrength,
              label: s1 + " + " + s2 + " mcg/hour (total " + totalStrength + " mcg/hour, 72-hour patches)",
              omed: totalOmed,
              omedText: "≈ " + Math.round(totalOmed) + " mg/24h oral morphine"
            });
          }
        }
      }

      if (!options.length) {
        const last = fentanylTable[fentanylTable.length - 1];
        options.push({
          type: "single",
          strength: last.strength,
          label: last.label,
          omed: adjOMED,
          omedText: "≥ " + last.min + " mg/24h oral morphine"
        });
      }

      options.sort((a, b) => Math.abs(a.omed - adjOMED) - Math.abs(b.omed - adjOMED));
      return options;
    }

    function renderBuprenorphineChoice(adjOMED, choice) {
      if (choice.type === "combo") {
        return (
          "<strong>Buprenorphine patches: " + choice.label + ".</strong><br>" +
          "Based on adjusted OMED ≈ " + Math.round(adjOMED) + " mg/24 h and standard buprenorphine patch bands (" +
          choice.omedText + "). Choose lower strengths in frailty or if uncertain, and titrate with local palliative-care guidance."
        );
      }
      return (
          "<strong>Buprenorphine patch: " + choice.strength + " micrograms/hour, " + choice.freq + ".</strong><br>" +
          "Based on adjusted OMED ≈ " + Math.round(adjOMED) + " mg/24 h and standard buprenorphine patch bands (" +
          choice.omedText + ")."
      );
    }

    function renderFentanylChoice(adjOMED, choice) {
      if (choice.type === "combo") {
        return (
          "<strong>Fentanyl patches: " + choice.label + ".</strong><br>" +
          "Based on adjusted OMED ≈ " + Math.round(adjOMED) + " mg/24 h and standard fentanyl patch conversion bands (" +
          choice.omedText + "). Monitor closely for sedation and toxicity."
        );
      }
      return (
        "<strong>Fentanyl patch: " + choice.strength + " micrograms/hour (72-hour patch).</strong><br>" +
        "Based on adjusted OMED ≈ " + Math.round(adjOMED) + " mg/24 h and standard fentanyl patch conversion bands (" +
        choice.omedText + ")."
      );
    }

    // ===== Core calculation =====
    function calculateConversion() {
      const frailtySelect = document.getElementById("frailtyFactor");
      const errorEl = document.getElementById("frailtyError");
      if (!frailtySelect.value) {
        if (errorEl) errorEl.style.display = "block";
        return;
      } else if (errorEl) {
        errorEl.style.display = "none";
      }

      const rows = document.querySelectorAll(".opioid-row");
      let totalOmed = 0;
      const parts = [];

      rows.forEach(row => {
        const select = row.querySelector(".opioid-select");
        const doseInput = row.querySelector(".dose-input");
        if (!select || !doseInput) return;

        const key = select.value;
        const doseVal = parseFloat(doseInput.value);
        if (!doseVal || !opioidFactors[key]) return;

        const omed = opioidFactors[key].toMorphine(doseVal);
        totalOmed += omed;
        const factor = opioidFactors[key].factor || (omed / doseVal);
        parts.push({
          label: opioidFactors[key].label,
          dose: doseVal,
          omed: omed,
          factor: factor
        });
      });

      const omedBox = document.getElementById("omedOutput");
      const targetBox = document.getElementById("targetOutput");
      const prnBox = document.getElementById("prnOutput");
      const noteBox = document.getElementById("clinicianNoteOutput");
      const brForm = document.getElementById("brForm");
      const convertBtn = document.getElementById("convertBtn");

      if (totalOmed === 0) {
        omedBox.textContent = "No valid doses entered.";
        targetBox.textContent = "";
        prnBox.textContent = "";
        noteBox.value = "";
        return;
      }

      const omedRounded = Math.round(totalOmed);
      const frailty = parseFloat(frailtySelect.value);
      const adjOMED = omedRounded * frailty;
      const targetKey = document.getElementById("targetOpioid").value;

      omedBox.innerHTML =
        "<strong>Approximate total oral morphine equivalent: " + omedRounded + " mg/24 h.</strong><br>" +
        "(Adjusted for frailty factor " + frailty + ": ≈ " + Math.round(adjOMED) + " mg/24 h).";

      // PRN base from adjusted OMED
      const basePrn = adjOMED / 6;
      let prnDrug = "Morphine immediate-release (e.g. Oramorph)";
      let prnDose = basePrn;

      if (brForm) {
        const form = brForm.value || "oramorph";
        if (form === "sc_morphine") {
          prnDrug = "Morphine SC";
          prnDose = basePrn / 2;
        } else if (form === "diamorphine") {
          prnDrug = "Diamorphine SC";
          prnDose = basePrn / 3;
        } else if (form === "oxynorm") {
          prnDrug = "Oxycodone IR (Oxynorm)";
          prnDose = basePrn / 2;
        }
      }
      const isSC = /SC/.test(prnDrug);
      const roundedPrn = isSC ? Math.max(1, Math.round(prnDose)) : roundTo(prnDose, 2.5, 2.5);
      prnBox.innerHTML =
        "Suggested breakthrough dose (approx.):
" +
        "<strong>• " + prnDrug + ": " + roundedPrn + " mg up to 4-hourly PRN.</strong>
" +
        "Adjust for renal function, age, frailty and local guidance.";

      const baseContext = {
        omedRounded: omedRounded,
        adjOMED: adjOMED,
        frailty: frailty,
        targetKey: targetKey,
        parts: parts,
        prnDrug: prnDrug,
        roundedPrn: roundedPrn
      };

      if (targetKey === "buprenorphine_patch") {
        const options = getBuprenorphineOptions(adjOMED);
        if (options.length > 1) {
          openDoseChoiceModal(
            baseContext,
            options,
            "Adjusted OMED ≈ " + Math.round(adjOMED) +
            " mg/24 h sits between or above standard buprenorphine patch bands. " +
            "Please choose the most appropriate patch or patch combination, taking frailty, comorbidity and clinical context into account."
          );
          if (convertBtn) convertBtn.disabled = true;
          targetBox.innerHTML =
            "Multiple buprenorphine patch strengths or combinations are clinically possible at this OMED. " +
            "Please choose one in the dose selection dialog.";
          noteBox.value = "";
          return;
        } else if (options.length === 1) {
          finaliseOutputsWithChoice(baseContext, options[0]);
          if (convertBtn) convertBtn.disabled = true;
          return;
        } else {
          targetBox.textContent =
            "Adjusted OMED is too low or atypical for standard buprenorphine patch conversion – consider an alternative opioid or seek specialist advice.";
        }
      } else if (targetKey === "fentanyl_patch") {
        const options = getFentanylOptions(adjOMED);
        if (options.length > 1) {
          openDoseChoiceModal(
            baseContext,
            options,
            "Adjusted OMED ≈ " + Math.round(adjOMED) +
            " mg/24 h lies across more than one fentanyl patch band or requires more than one patch. " +
            "Please choose the most appropriate option, taking frailty and clinical context into account."
          );
          if (convertBtn) convertBtn.disabled = true;
          targetBox.innerHTML =
            "Multiple fentanyl patch strengths or combinations are clinically possible at this OMED. " +
            "Please choose one in the dose selection dialog.";
          noteBox.value = "";
          return;
        } else if (options.length === 1) {
          finaliseOutputsWithChoice(baseContext, options[0]);
          if (convertBtn) convertBtn.disabled = true;
          return;
        } else {
          targetBox.textContent =
            "Adjusted OMED is outside the usual range for standard fentanyl patch conversion – consider alternative regimen or specialist advice.";
        }
      } else {
        // Non-patch targets (oral morphine/oxycodone, SC morphine/diamorphine)
        let targetHtml = "";
        let targetLine = "";

        if (targetKey === "oral_morphine") {
          const idealBd = adjOMED / 2;
          const strengths = [10, 15, 30, 60, 100, 200];
          let lower = strengths[0];
          let higher = strengths[strengths.length - 1];

          for (let i = 0; i < strengths.length; i++) {
            if (strengths[i] <= idealBd) {
              lower = strengths[i];
            }
            if (strengths[i] >= idealBd) {
              higher = strengths[i];
              break;
            }
          }

          targetHtml =
            "<strong>Oral morphine: ≈ " + Math.round(adjOMED) + " mg/24 h total.</strong><br>" +
            "Aim for a 12-hour MR regimen using commonly available tablet strengths.<br>" +
            "Closest lower BNF MR dose: " + lower + " mg twice daily (total " + (lower * 2) + " mg/24 h).<br>";
          if (higher !== lower) {
            targetHtml +=
              "Higher alternative BNF MR dose: " + higher + " mg twice daily (total " + (higher * 2) + " mg/24 h).<br>";
          }
          targetHtml +=
            "Round down in frailty or if there are safety concerns, and always cross-check with the BNF and local guidance.";

          targetLine =
            "Target opioid: Oral morphine MR regimen based on adjusted OMED ≈ " +
            Math.round(adjOMED) + " mg/24 h (BNF MR tablet strengths " + strengths.join(", ") + " mg).";
        } else if (targetKey === "oral_oxycodone") {
          const oxyTotal = adjOMED / 1.5;
          const bd = roundTo(oxyTotal / 2, 2.5, 2.5);
          targetHtml =
            "<strong>Oral oxycodone: ≈ " + Math.round(oxyTotal) + " mg/24 h total.</strong><br>" +
            "For example: " + bd + " mg MR twice daily (plus breakthrough), rounding down and checking BNF-licensed strengths.";
          targetLine =
            "Target opioid: Oral oxycodone MR regimen based on adjusted OMED ≈ " +
            Math.round(adjOMED) + " mg/24 h (conversion factor oral oxycodone → oral morphine ≈ 1.5).";
        } else if (targetKey === "sc_morphine") {
          const sc = adjOMED / 2;
          targetHtml =
            "<strong>Morphine SC: ≈ " + Math.round(sc) + " mg/24 h via syringe driver.</strong><br>" +
            "Dose assumes SC morphine ≈ 2 × oral morphine potency. Adjust per local palliative care guidance.";
          targetLine =
            "Target opioid: Morphine SC ≈ " + Math.round(sc) +
            " mg/24 h (conversion factor SC morphine → oral morphine ≈ 2).";
        } else if (targetKey === "sc_diamorphine") {
          const dia = adjOMED / 3;
          targetHtml =
            "<strong>Diamorphine SC: ≈ " + Math.round(dia) + " mg/24 h via syringe driver.</strong><br>" +
            "Dose assumes diamorphine ≈ 3 × oral morphine potency. Consider renal function and seek specialist advice if unsure.";
          targetLine =
            "Target opioid: Diamorphine SC ≈ " + Math.round(dia) +
            " mg/24 h (conversion factor diamorphine SC → oral morphine ≈ 3).";
        }

        targetBox.innerHTML = targetHtml;

        const noteLines = [];
        noteLines.push("Approximate total OMED: ~" + omedRounded + " mg/24 h (estimate).");
        noteLines.push("Frailty factor applied: " + frailty + " → adjusted OMED ≈ " + Math.round(adjOMED) + " mg/24 h.");
        if (parts.length) {
          noteLines.push("Current opioids and approximate OMED (factor used):");
          parts.forEach(p => {
            noteLines.push(
              " - " + p.label + ": " + p.dose + " × " + p.factor +
              " ≈ " + Math.round(p.omed) + " mg OMED"
            );
          });
        }
        if (targetLine) {
          noteLines.push(targetLine);
        } else {
          noteLines.push("Target opioid: " + document.getElementById("targetOpioid").selectedOptions[0].text + ".");
        }
        noteLines.push(
          "Breakthrough: " + prnDrug + " approx " + roundedPrn +
          " mg up to 4-hourly PRN (adjust for renal function, age, frailty and local guidance)."
        );
        noteLines.push(
          "These opioid conversions are approximate and depend on patient-specific factors. " +
          "Monitor pain control and adverse effects closely. Consider specialist palliative care input for high doses, frailty, or complex regimens."
        );
        noteBox.value = noteLines.join("\n");

        if (convertBtn) convertBtn.disabled = true;
      }
    }

    function finaliseOutputsWithChoice(ctx, choice) {
      const targetBox = document.getElementById("targetOutput");
      const noteBox = document.getElementById("clinicianNoteOutput");
      const prnBox = document.getElementById("prnOutput");
      const targetKey = ctx.targetKey;

      let targetHtml = "";
      let targetLine = "";

      if (targetKey === "buprenorphine_patch") {
        targetHtml = renderBuprenorphineChoice(ctx.adjOMED, choice);
        if (choice.type === "combo") {
          targetLine = "Target opioid: Buprenorphine patches – " + choice.label +
                       ", covering approximately " + choice.omedText + ".";
        } else {
          targetLine = "Target opioid: Buprenorphine patch " + choice.strength +
                       " mcg/hour (" + choice.freq + "), covering approximately " + choice.omedText + ".";
        }
      } else if (targetKey === "fentanyl_patch") {
        targetHtml = renderFentanylChoice(ctx.adjOMED, choice);
        if (choice.type === "combo") {
          targetLine = "Target opioid: Fentanyl patches – " + choice.label +
                       ", covering approximately " + choice.omedText + ".";
        } else {
          targetLine = "Target opioid: Fentanyl patch " + choice.strength +
                       " mcg/hour (72-hour), mapped to " + choice.omedText + ".";
        }
      }

      targetBox.innerHTML = targetHtml;

      const noteLines = [];
      noteLines.push("Approximate total OMED: ~" + ctx.omedRounded + " mg/24 h (estimate).");
      noteLines.push("Frailty factor applied: " + ctx.frailty +
                     " → adjusted OMED ≈ " + Math.round(ctx.adjOMED) + " mg/24 h.");
      if (ctx.parts && ctx.parts.length) {
        noteLines.push("Current opioids and approximate OMED (factor used):");
        ctx.parts.forEach(p => {
          noteLines.push(
            " - " + p.label + ": " + p.dose + " × " + p.factor +
            " ≈ " + Math.round(p.omed) + " mg OMED"
          );
        });
      }
      noteLines.push(targetLine);
      noteLines.push(
        "Breakthrough: " + ctx.prnDrug + " approx " + ctx.roundedPrn +
        " mg up to 4-hourly PRN (adjust for renal function, age, frailty and local guidance)."
      );
      noteLines.push(
        "These opioid conversions are approximate and depend on patient-specific factors. " +
        "Monitor pain control and adverse effects closely. Consider specialist palliative care input for high doses, frailty, or complex regimens."
      );
      noteBox.value = noteLines.join("\n");

      prnBox.innerHTML +=
        "\nUse a lower dose and longer interval if concerned about over-sedation or toxicity.";
    }

    function initOpioidTool() {
      const addBtn = document.getElementById("addOpioidBtn");
      const clearBtn = document.getElementById("clearOpioidsBtn");
      const convertBtn = document.getElementById("convertBtn");
      const clearOutputsBtn = document.getElementById("clearOutputsBtn");
      const copyBtn = document.getElementById("copyClinicianBtn");
      const targetSel = document.getElementById("targetOpioid");
      const frailtySel = document.getElementById("frailtyFactor");
      const brForm = document.getElementById("brForm");
      const modalConfirm = document.getElementById("doseModalConfirm");
      const modalCancel = document.getElementById("doseModalCancel");

      addBtn.addEventListener("click", addOpioidRow);
      clearBtn.addEventListener("click", clearOpioidRows);
      convertBtn.addEventListener("click", calculateConversion);
      clearOutputsBtn.addEventListener("click", () => {
        clearOutputs();
        markDirty();
      });
      copyBtn.addEventListener("click", () => {
        const note = document.getElementById("clinicianNoteOutput").value;
        if (!note) return;
        navigator.clipboard.writeText(note).then(() => {
          copyBtn.textContent = "Copied";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1500);
        }).catch(() => {});
      });

      targetSel.addEventListener("change", markDirty);
      frailtySel.addEventListener("change", markDirty);
      brForm.addEventListener("change", markDirty);

      modalConfirm.addEventListener("click", handleDoseChoiceConfirm);
      modalCancel.addEventListener("click", handleDoseChoiceCancel);

      clearOpioidRows();
      convertBtn.disabled = !isFrailtyValid();
    }

    window.addEventListener("DOMContentLoaded", initOpioidTool);
  </script>
</body>
</html>
