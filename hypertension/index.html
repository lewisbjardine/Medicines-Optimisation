<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hypertension management assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<style>
main{max-width:1200px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.small{font-size:.82rem}
.section{margin-top:1.2rem}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem}
.matrix{border:1px solid var(--nhs-border);border-radius:4px;overflow:hidden}
.row{display:grid;grid-template-columns:180px repeat(6,1fr) 120px;gap:.25rem;padding:.38rem;border-bottom:1px solid #eee;align-items:center;font-size:.78rem}
.row:last-child{border-bottom:none}
.header-row{background:#f0f4f5;font-weight:bold}
.dose-btn{padding:.2rem .35rem;border:1px solid var(--nhs-border);border-radius:4px;text-align:center;cursor:pointer;user-select:none}
.dose-btn.current{background:#e8f4ff;border-color:#0072ce;font-weight:bold}
.dose-btn.blocked{background:#f5f5f5;color:#888;text-decoration:line-through}
.block-btn{font-size:.7rem}
.instructions{background:#f0f4f5;border-left:4px solid #0072ce;padding:.6rem;margin-bottom:.8rem;font-size:.82rem}
.kegfr{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.output-head{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
textarea{width:100%;min-height:7.5rem}
.flag-add{color:#00703c;font-weight:bold}
.flag-change{color:#6f4c00;font-weight:bold}
.flag-stop{color:#d4351c;font-weight:bold}
.alert{border-radius:4px;padding:.6rem;margin:.4rem 0;font-size:.85rem}
.alert.warn{background:#fdecea;border:1px solid #d4351c}
.alert.info{background:#e8f4ff;border:1px solid #0072ce}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--nhs-border);font-size:.78rem;background:#fff}
</style>
</head>
<body>

<header>
<h1>Hypertension management assistant</h1>
<p class="subtitle">NICE NG136 aligned – decision support only</p>
<a href="../index.html" class="return-home">Back to home</a>
</header>

<main>

<div class="instructions">
<strong>Medication entry:</strong>
• <strong>Click</strong> a dose to select / unselect the <em>current</em> dose<br>
• <strong>Double‑click</strong> a dose to mark as <em>not tolerated</em> (blocked)<br>
• <strong>Click</strong> a blocked dose to reset it<br>
• Use <strong>Block</strong> on the right to block the whole drug
</div>

<section class="card small">
<h2>1. Patient factors</h2>
<div class="grid">
  <div>
    <label>Age band</label>
    <select id="ageBand">
      <option value="lt55">&lt;55</option>
      <option value="55to79" selected>55–79</option>
      <option value="ge80">≥80</option>
    </select>
  </div>
  <div>
    <label>Ethnicity</label>
    <select id="ethnicity">
      <option value="other">White / Other</option>
      <option value="black">Black African or Caribbean</option>
    </select>
  </div>
  <div>
    <label>Risk factors / comorbidity</label>
    <select id="risks" multiple size="6">
      <option value="dm">Diabetes</option>
      <option value="ckd">Chronic kidney disease</option>
      <option value="proteinuria">Proteinuria / ACR elevated</option>
      <option value="ihd">Ischaemic heart disease</option>
      <option value="hf">Heart failure</option>
      <option value="stroke">Previous stroke/TIA</option>
    </select>
    <div class="hint">Hold Ctrl / Cmd to select multiple</div>
  </div>
</div>
</section>

<section class="card section small">
<h2>2. Current antihypertensive treatment</h2>

<div class="grid-2">
  <div>
    <h3>A – ACE inhibitors</h3>
    <div class="matrix" id="ACE"></div>
    <h3 style="margin-top:.8rem">A – ARBs</h3>
    <div class="matrix" id="ARB"></div>
  </div>
  <div>
    <h3>C – Calcium-channel blockers</h3>
    <div class="matrix" id="CCB"></div>
    <h3 style="margin-top:.8rem">D – Thiazide / thiazide-like</h3>
    <div class="matrix" id="THZ"></div>
    <h3 style="margin-top:.8rem">Other / Step 4</h3>
    <div class="matrix" id="OTH"></div>
  </div>
</div>
</section>

<section class="card section small">
<h2>3. Blood pressure and safety</h2>
<div class="grid">
  <div>
    <label>BP measurement type</label>
    <select id="bpType">
      <option value="clinic">Clinic</option>
      <option value="home">Home / ABPM</option>
    </select>
  </div>
  <div>
    <label>BP</label>
    <input id="bpValue" placeholder="e.g. 152/94">
    <div class="hint" id="targetHint"></div>
  </div>
</div>

<div class="kegfr">
  <div>
    <label>Potassium (optional, for Step 4)</label>
    <input id="kVal" placeholder="e.g. 4.3">
  </div>
  <div>
    <label>eGFR (optional, for Step 4)</label>
    <input id="egfrVal" placeholder="e.g. 62">
  </div>
</div>
</section>

<section class="card section small">
<h2>4. Recommendation</h2>

<div class="output-head">
  <button id="genBtn">Generate plan</button>
  <button class="secondary" id="clearBtn">Clear</button>
</div>

<div id="alerts"></div>

<div class="output-head" style="margin-top:.7rem">
  <strong>Medication plan</strong>
  <span class="pill" id="stepBadge">Step –</span>
</div>
<div class="output-box" id="planBox"></div>

<div style="margin-top:.8rem">
  <div class="output-head">
    <strong>Clinician note</strong>
    <button class="copy-btn" id="copyClin">Copy</button>
  </div>
  <textarea id="clinicianText" readonly></textarea>
</div>

<div style="margin-top:.8rem">
  <div class="output-head">
    <strong>Patient information</strong>
    <button class="copy-btn" id="copyPt">Copy</button>
  </div>
  <textarea id="patientText" readonly></textarea>
</div>

</section>

</main>

<footer>NICE NG136 • Supports clinical judgement • Not a prescribing instruction</footer>

<script>
/* ---------------------- Drug data (per Ardens screenshots) ---------------------- */
const DATA = {
 ACE: [
  ["Lisinopril",["2.5","5","10","20","30","40"], {class:"A", group:"ACE"}],
  ["Perindopril",["2","4","6","8"], {class:"A", group:"ACE"}],
  ["Ramipril",["1.25","2.5","5","10"], {class:"A", group:"ACE"}],
  ["Captopril",["6.25","12.5","25","50","75"], {class:"A", group:"ACE"}],
  ["Enalapril",["2.5","5","10","20","40"], {class:"A", group:"ACE"}],
  ["Fosinopril",["10","20","40"], {class:"A", group:"ACE"}],
  ["Imidapril",["2.5","5","10","20"], {class:"A", group:"ACE"}],
  ["Trandolapril",["0.5","1","2","4"], {class:"A", group:"ACE"}]
 ],
 ARB: [
  ["Candesartan",["4","8","16","32"], {class:"A", group:"ARB"}],
  ["Irbesartan",["75","150","225","300"], {class:"A", group:"ARB"}],
  ["Losartan",["25","50","100"], {class:"A", group:"ARB"}],
  ["Azilsartan",["20","40","80"], {class:"A", group:"ARB"}],
  ["Eprosartan",["600"], {class:"A", group:"ARB"}],
  ["Olmesartan",["10","20","40"], {class:"A", group:"ARB"}],
  ["Telmisartan",["20","40","80"], {class:"A", group:"ARB"}],
  ["Valsartan",["40","80","160","240"], {class:"A", group:"ARB"}]
 ],
 CCB: [
  ["Amlodipine",["5","10"], {class:"C"}],
  ["Felodipine MR",["2.5","5","10","20"], {class:"C"}],
  ["Lacidipine",["2","4","6"], {class:"C"}],
  ["Lercanidipine",["10","20"], {class:"C"}],
  ["Nicardipine",["20","30","40"], {class:"C"}], // tds (not modelled in frequency)
  ["Nifedipine MR",["30","60","90"], {class:"C"}]
 ],
 THZ: [
  ["Indapamide",["2.5"], {class:"D"}],
  ["Chlortalidone",["25","50"], {class:"D"}],
  ["Metolazone",["2.5","5"], {class:"D"}],
  ["Xipamide",["20"], {class:"D"}],
  ["Bendroflumethiazide",["2.5"], {class:"D", note:"Less preferred – continue if stable, not for initiation"}]
 ],
 OTH: [
  ["Spironolactone",["25"], {class:"O", subtype:"MRA", note:"Consider only if K ≤4.5 and eGFR adequate"}],
  ["Doxazosin",["1","2","4"], {class:"O", subtype:"Alpha"}],
  ["Terazosin",["1","2","5","10"], {class:"O", subtype:"Alpha"}],
  ["Bisoprolol",["2.5","5","10"], {class:"O", subtype:"Beta"}],
  ["Carvedilol",["12.5","25","50"], {class:"O", subtype:"Beta"}],
  ["Nebivolol",["2.5","5"], {class:"O", subtype:"Beta"}],
  ["Atenolol",["25","50"], {class:"O", subtype:"Beta"}],
  ["Metoprolol",["100","200"], {class:"O", subtype:"Beta"}],
  ["Propranolol",["80","160"], {class:"O", subtype:"Beta"}],
  ["Timolol",["5","10","20","30"], {class:"O", subtype:"Beta"}]
 ]
};

// Preferred order when starting a class
const PREFERRED = {
 A: ["Ramipril","Lisinopril","Losartan","Candesartan","Irbesartan"],
 C: ["Amlodipine","Felodipine MR","Lercanidipine","Nifedipine MR","Lacidipine","Nicardipine"],
 D: ["Indapamide","Chlortalidone","Xipamide","Metolazone"], // avoid Bendroflumethiazide initiation
 O: ["Spironolactone","Doxazosin","Bisoprolol"]
};

const state = {}; // per drug: {c: string|null, b:Set, bd:boolean}
const drugMeta = {}; // name -> {doses, class, group/subtype, note}
(function buildMeta(){
  ["ACE","ARB","CCB","THZ","OTH"].forEach(sec=>{
    DATA[sec].forEach(([name,doses,meta])=>{
      drugMeta[name] = { doses: doses.slice(), ...(meta||{}) };
    });
  });
})();

/* ---------------------- UI rendering ---------------------- */
function renderSection(id){
  const box=document.getElementById(id);
  box.innerHTML="";
  const header=document.createElement("div");
  header.className="row header-row";
  header.innerHTML="<div>Drug</div>"+Array(6).fill("<div>Dose</div>").join("")+"<div></div>";
  box.appendChild(header);

  DATA[id].forEach(([name,doses,meta])=>{
    if(!state[name]) state[name]={c:null,b:new Set(),bd:false};
    const s=state[name];

    const row=document.createElement("div");
    row.className="row";

    const nameCell=document.createElement("div");
    nameCell.textContent=name + ((meta && meta.note) ? " *" : "");
    row.appendChild(nameCell);

    for(let i=0;i<6;i++){
      const cell=document.createElement("div");
      if(doses[i]){
        const btn=document.createElement("div");
        btn.className="dose-btn";
        btn.textContent=doses[i]+" mg";
        if(s.c===doses[i]) btn.classList.add("current");
        if(s.b.has(doses[i]) || s.bd) btn.classList.add("blocked");

        btn.onclick=()=>{
          // click: if blocked -> reset; else toggle current
          if(s.bd) return; // whole drug blocked
          if(s.b.has(doses[i])){
            s.b.delete(doses[i]);
          } else {
            s.c = (s.c===doses[i]) ? null : doses[i];
          }
          renderAll();
        };

        btn.ondblclick=()=>{
          if(s.bd) return;
          if(s.c===doses[i]) s.c=null;
          s.b.add(doses[i]);
          renderAll();
        };

        cell.appendChild(btn);
      }
      row.appendChild(cell);
    }

    const block=document.createElement("button");
    block.className="secondary block-btn";
    block.textContent=s.bd ? "Unblock" : "Block";
    block.onclick=()=>{
      s.bd=!s.bd;
      if(s.bd){
        s.c=null;
        s.b=new Set(doses);
      } else {
        s.b.clear();
      }
      renderAll();
    };
    row.appendChild(block);

    box.appendChild(row);
  });
}

function renderAll(){
  renderSection("ACE");
  renderSection("ARB");
  renderSection("CCB");
  renderSection("THZ");
  renderSection("OTH");
}
renderAll();

/* ---------------------- Helpers ---------------------- */
function selectedRisks(){
  const sel=[...document.getElementById("risks").selectedOptions].map(o=>o.value);
  return new Set(sel);
}
function parseBP(){
  const v=document.getElementById("bpValue").value.trim();
  const m=v.match(/(\d+)(?:\/(\d+))?/);
  if(!m) return null;
  return {sys: parseInt(m[1],10), dia: m[2]?parseInt(m[2],10):null};
}
function getTargets(){
  const age=document.getElementById("ageBand").value;
  const bpType=document.getElementById("bpType").value;
  const ge80 = (age==="ge80");
  if(bpType==="clinic"){
    return ge80 ? {sys:150,dia:90} : {sys:140,dia:90};
  } else {
    return ge80 ? {sys:145,dia:85} : {sys:135,dia:85};
  }
}
function updateTargetHint(){
  const t=getTargets();
  document.getElementById("targetHint").textContent = `Target: <${t.sys}/${t.dia} (${document.getElementById("bpType").value==="clinic"?"clinic":"home/ABPM"})`;
}
document.getElementById("bpType").addEventListener("change", updateTargetHint);
document.getElementById("ageBand").addEventListener("change", updateTargetHint);
updateTargetHint();

function getCurrentMeds(){
  const meds=[];
  Object.keys(state).forEach(name=>{
    const s=state[name];
    if(s.c && !s.bd){
      const meta=drugMeta[name]||{};
      meds.push({name, dose:s.c, class:meta.class || "?", group:meta.group, subtype:meta.subtype});
    }
  });
  return meds;
}
function hasClass(cls){
  return getCurrentMeds().some(m=>m.class===cls);
}
function currentInClass(cls){
  return getCurrentMeds().filter(m=>m.class===cls);
}
function isDoseBlocked(name, dose){
  const s=state[name];
  if(!s) return true;
  return s.bd || s.b.has(dose);
}
function nextDose(name, currentDose){
  const doses=(drugMeta[name]?.doses)||[];
  const idx=doses.indexOf(currentDose);
  if(idx<0) return null;
  for(let i=idx+1;i<doses.length;i++){
    if(!isDoseBlocked(name, doses[i])) return doses[i];
  }
  return null;
}
function firstAvailableDose(name){
  const doses=(drugMeta[name]?.doses)||[];
  for(const d of doses){
    if(!isDoseBlocked(name,d)) return d;
  }
  return null;
}
function chooseDrugForClass(cls, excludeNames=new Set()){
  const list = (PREFERRED[cls]||[]);
  // try preferred list first, then any drug in that class
  const candidates = [...list, ...Object.keys(drugMeta).filter(n=>drugMeta[n].class===cls)];
  for(const name of candidates){
    if(excludeNames.has(name)) continue;
    if((drugMeta[name]?.class)!==cls) continue;
    if(state[name]?.bd) continue;
    const d = firstAvailableDose(name);
    if(d) return {name, dose:d};
  }
  return null;
}
function bpUncontrolled(bp, target){
  if(!bp) return false;
  if(bp.sys >= target.sys) return true;
  if(bp.dia!=null && bp.dia >= target.dia) return true;
  return false;
}
function severeBP(bp){
  if(!bp) return false;
  // conservative: urgent if >=180 systolic or >=120 diastolic
  return (bp.sys >= 180) || (bp.dia!=null && bp.dia >= 120);
}

/* ---------------------- NICE-ish step logic (safe, transparent) ---------------------- */
function inferStep(){
  const A = hasClass("A");
  const C = hasClass("C");
  const D = hasClass("D");
  if(!A && !C && !D) return 0;
  if((A && !C && !D) || (!A && C && !D)) return 1;
  if(A && C && !D) return 2;
  if(A && C && D) return 3;
  // other combinations: treat as "custom"
  return 9;
}

function firstLinePreference(){
  const age=document.getElementById("ageBand").value;
  const eth=document.getElementById("ethnicity").value;
  const risks=selectedRisks();
  const ckdOrProt = risks.has("ckd") || risks.has("proteinuria");
  const dm = risks.has("dm");
  // NICE: CKD/proteinuria (especially with diabetes) generally favors ACEi/ARB (A)
  if(ckdOrProt || dm){
    return "A";
  }
  const ge55 = (age!=="lt55");
  if(eth==="black" || ge55) return "C";
  return "A";
}

function monitoringFor(action){
  // return array of strings
  const labs = [];
  if(action.includes("ACE") || action.includes("ARB") || action.includes("A (ACEi/ARB)") || action.includes("diuretic") || action.includes("spironolactone")){
    labs.push("U&Es (Na/K/creatinine/eGFR) 1–2 weeks after starting or dose increase, then again at 4–6 weeks if needed.");
  }
  return labs;
}

function generatePlan(){
  const alerts=[];
  const bp=parseBP();
  const target=getTargets();
  const uncontrolled = bp ? bpUncontrolled(bp,target) : null;

  document.getElementById("alerts").innerHTML="";
  document.getElementById("planBox").innerHTML="";
  document.getElementById("clinicianText").value="";
  document.getElementById("patientText").value="";
  document.getElementById("stepBadge").textContent="Step –";

  if(!bp){
    alerts.push({type:"warn", text:"Enter a valid BP (e.g. 152/94)."});
  } else if(severeBP(bp)){
    alerts.push({type:"warn", text:"Very high BP entered (≥180 systolic or ≥120 diastolic). Consider urgent same‑day clinical assessment depending on symptoms and context."});
  }

  // show alerts
  for(const a of alerts){
    const div=document.createElement("div");
    div.className="alert "+(a.type==="warn"?"warn":"info");
    div.textContent=a.text;
    document.getElementById("alerts").appendChild(div);
  }
  if(!bp) return;

  const meds=getCurrentMeds();
  const step=inferStep();
  document.getElementById("stepBadge").textContent = (step===9) ? "Custom" : ("Step "+step);

  const lines=[];
  const clin=[];
  const pt=[];

  clin.push(`Hypertension review (NICE NG136 aligned).`);
  clin.push(`BP (${document.getElementById("bpType").value==="clinic"?"clinic":"home/ABPM"}): ${bp.sys}${bp.dia!=null?"/"+bp.dia:""} mmHg. Target <${target.sys}/${target.dia}.`);
  clin.push(`Current antihypertensives: ${meds.length?meds.map(m=>m.name+" "+m.dose+" mg").join(", "):"none recorded"}.`);

  if(!uncontrolled){
    lines.push(`<span class="flag-change">No intensification suggested:</span> BP is at/under target.`);
    lines.push(`Continue current regimen. Recheck BP routinely (e.g. 6–12 months) and reinforce lifestyle / adherence.`);
    pt.push(`Your blood pressure is within the target range.`);
    pt.push(`Continue your current tablets as prescribed. We'll recheck your blood pressure again routinely.`);
  } else {
    lines.push(`<span class="flag-change">BP above target</span> (target <${target.sys}/${target.dia}).`);
    lines.push(`First check technique, adherence, white‑coat effect and consider home/ABPM if clinic readings.`);

    // Stepwise recommendations
    const actions=[]; // for clinician note + patient note
    const risks=selectedRisks();

    // Decide what to do next:
    // 1) Try titration of existing A/C/D before adding
    function tryTitrateClass(cls){
      const items=currentInClass(cls);
      for(const m of items){
        const nxt=nextDose(m.name, m.dose);
        if(nxt){
          return {type:"titrate", cls, name:m.name, from:m.dose, to:nxt};
        }
      }
      return null;
    }

    // Determine missing classes for standard A+C+D pathway
    const haveA=hasClass("A"), haveC=hasClass("C"), haveD=hasClass("D");

    let rec = null;

    if(step===0){
      const first = firstLinePreference(); // "A" or "C"
      const chosen = chooseDrugForClass(first);
      if(chosen){
        rec = {type:"start", cls:first, ...chosen};
      } else {
        rec = {type:"info", text:`No available drug found in preferred class ${first} (all blocked). Consider alternative class or specialist advice.`};
      }
    } else if(step===1){
      // if only A or only C: titrate that if possible, else add the missing one
      if(haveA && !haveC){
        rec = tryTitrateClass("A") || (chooseDrugForClass("C") ? {type:"add", cls:"C", ...chooseDrugForClass("C")} : {type:"info", text:"No available CCB found (all blocked)."});
      } else if(haveC && !haveA){
        rec = tryTitrateClass("C") || (chooseDrugForClass("A") ? {type:"add", cls:"A", ...chooseDrugForClass("A")} : {type:"info", text:"No available ACEi/ARB found (all blocked)."});
      } else {
        // unusual combo: treat as custom, titrate any A/C if present
        rec = tryTitrateClass("C") || tryTitrateClass("A") || {type:"info", text:"Combination not standard Step 1. Review and consider A+C approach."};
      }
    } else if(step===2){
      // A + C: titrate C then A if possible; else add D
      rec = tryTitrateClass("C") || tryTitrateClass("A");
      if(!rec){
        const dChoice = chooseDrugForClass("D", new Set(["Bendroflumethiazide"]));
        if(dChoice){
          rec = {type:"add", cls:"D", ...dChoice};
        } else {
          rec = {type:"info", text:"No suitable thiazide-like option available (all blocked)."};
        }
      }
    } else if(step===3){
      // A + C + D: titrate any (C then A then D), else Step 4
      rec = tryTitrateClass("C") || tryTitrateClass("A") || tryTitrateClass("D");
      if(!rec){
        // Step 4: consider spironolactone if safe, else alpha/beta
        const k = parseFloat(document.getElementById("kVal").value);
        const egfr = parseFloat(document.getElementById("egfrVal").value);
        const kOk = !isNaN(k) ? (k <= 4.5) : null;
        const egfrOk = !isNaN(egfr) ? (egfr >= 45) : null;

        const spiroAvailable = chooseDrugForClass("O", new Set())?.name === "Spironolactone" ? firstAvailableDose("Spironolactone") : firstAvailableDose("Spironolactone");
        const spiroBlocked = state["Spironolactone"]?.bd;

        if(!spiroBlocked && spiroAvailable && (kOk===true && egfrOk===true)){
          rec = {type:"add", cls:"O", name:"Spironolactone", dose:"25", note:"Only if K ≤4.5 and eGFR ≥45"};
        } else {
          rec = {type:"info", text:"Resistant hypertension (Step 4): consider spironolactone 25 mg OD if K ≤4.5 and eGFR ≥45, or consider an alpha-blocker/beta-blocker if not suitable. Ensure U&Es checked. Consider specialist input."};
        }
        if(kOk===null || egfrOk===null){
          // if missing labs, nudge
          alerts.push({type:"info", text:"Step 4 decisions often need recent potassium and eGFR. Enter values if available, or plan bloods before adding spironolactone."});
        }
      }
    } else {
      // custom regimen
      rec = tryTitrateClass("C") || tryTitrateClass("A") || tryTitrateClass("D") || {type:"info", text:"Current regimen is non‑standard. Consider aligning to A+C+D pathway and check adherence/secondary causes."};
    }

    // render additional info alerts for step4
    if(alerts.length){
      document.getElementById("alerts").innerHTML="";
      for(const a of alerts){
        const div=document.createElement("div");
        div.className="alert "+(a.type==="warn"?"warn":"info");
        div.textContent=a.text;
        document.getElementById("alerts").appendChild(div);
      }
    }

    if(rec){
      if(rec.type==="titrate"){
        lines.push(`<span class="flag-change">TITRATE:</span> Increase <strong>${rec.name}</strong> from ${rec.from} mg to <strong>${rec.to} mg</strong> (if tolerated).`);
        actions.push({kind:"titrate", text:`Increase ${rec.name} from ${rec.from} mg to ${rec.to} mg.`});
        clin.push(`Plan: increase ${rec.name} from ${rec.from} mg to ${rec.to} mg (if tolerated).`);
        pt.push(`We are increasing your blood pressure tablet ${rec.name} from ${rec.from} mg to ${rec.to} mg.`);
        pt.push(`This is a dose increase of a medicine you are already taking (not a new tablet).`);
      } else if(rec.type==="start"){
        const clsName = rec.cls==="A" ? "A (ACEi/ARB)" : rec.cls;
        lines.push(`<span class="flag-add">ADD:</span> Start <strong>${rec.name} ${rec.dose} mg</strong>.`);
        lines.push(`Review BP in 4–6 weeks and titrate if needed.`);
        actions.push({kind:"add", text:`Start ${rec.name} ${rec.dose} mg.`});
        clin.push(`Plan: start ${rec.name} ${rec.dose} mg (Step 1; class ${clsName}).`);
        pt.push(`We are starting a new blood pressure tablet: ${rec.name} ${rec.dose} mg.`);
        pt.push(`Take it in addition to your other regular medicines unless your clinician tells you otherwise.`);
      } else if(rec.type==="add"){
        lines.push(`<span class="flag-add">ADD:</span> Add <strong>${rec.name} ${rec.dose} mg</strong> to existing treatment.`);
        if(rec.cls==="D" && rec.name==="Bendroflumethiazide"){
          lines.push(`Note: bendroflumethiazide is less preferred for initiation.`);
        }
        actions.push({kind:"add", text:`Add ${rec.name} ${rec.dose} mg.`});
        clin.push(`Plan: add ${rec.name} ${rec.dose} mg (stepwise escalation).`);
        pt.push(`We are adding a new blood pressure tablet: ${rec.name} ${rec.dose} mg.`);
        pt.push(`This is <strong>in addition</strong> to your current blood pressure tablets.`);
      } else if(rec.type==="info"){
        lines.push(`<span class="flag-change">Review required:</span> ${rec.text}`);
        clin.push(`Plan: ${rec.text}`);
        pt.push(`Your blood pressure is above target. Your clinician will review the best next medication step based on your medical history and previous tolerability.`);
      }
    }

    // Monitoring plan (general)
    lines.push(`<br><strong>Monitoring:</strong>`);
    lines.push(`• Recheck BP in ~4–6 weeks after changes (earlier if very high BP or symptoms).`);
    lines.push(`• Encourage HBPM/ABPM if clinic readings may be affected by white‑coat effect.`);
    lines.push(`• Check adherence, lifestyle measures, and consider secondary causes if resistant.`);

    clin.push(`Monitoring: BP recheck 4–6 weeks. Labs if RAS blocker/diuretic/MRA change (U&Es 1–2 weeks).`);

    // Labs suggestions based on action kind and classes involved
    const needsLabs = actions.some(a=>a.kind==="add"||a.kind==="titrate");
    if(needsLabs){
      // if any A/D/O involved in plan, advise labs
      const planMentions = (clin.join(" ").toLowerCase());
      if(planMentions.includes("ramipril") || planMentions.includes("lisinopril") || planMentions.includes("losartan") || planMentions.includes("candesartan") || planMentions.includes("enalapril") || planMentions.includes("spironolactone") || planMentions.includes("indapamide") || planMentions.includes("chlortalidone") || planMentions.includes("metolazone") || planMentions.includes("xipamide")){
        pt.push(`You may need a blood test (kidney function and potassium) 1–2 weeks after this change. We'll advise you if this is needed.`);
      }
    }
  }

  document.getElementById("planBox").innerHTML = lines.map(l=>`<div>${l}</div>`).join("");

  // Build clinician + patient text blocks
  const clinText = clin.join("\n");
  document.getElementById("clinicianText").value = clinText;

  const ptText = pt.join("\n");
  document.getElementById("patientText").value = ptText;
}

document.getElementById("genBtn").addEventListener("click", generatePlan);
document.getElementById("clearBtn").addEventListener("click", ()=>location.reload());
document.getElementById("copyClin").addEventListener("click", ()=>navigator.clipboard.writeText(document.getElementById("clinicianText").value));
document.getElementById("copyPt").addEventListener("click", ()=>navigator.clipboard.writeText(document.getElementById("patientText").value));
</script>

</body>
</html>
