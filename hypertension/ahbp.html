<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AHBP / HBPM calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
main{max-width:900px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:.4rem}
input,textarea{width:100%}
</style>
</head>
<body>
<header>
<h1>AHBP / HBPM calculator</h1>
<a href="index.html" class="return-home">Back</a>
</header>
<main>

<label><strong>Paste BP readings</strong></label>
<textarea id="bpPaste" rows="4"></textarea>
<button id="parsePasteBtn">Parse pasted readings</button>

<label><strong>Upload BP image (beta)</strong></label>
<input type="file" id="bpImage" accept="image/*">

<button id="calcBtn">Calculate mean</button>
<button id="useBtn" disabled>Use mean BP</button>

<table>
<thead><tr><th>#</th><th>Systolic</th><th>Diastolic</th></tr></thead>
<tbody id="tbody"></tbody>
</table>

<div><strong>Mean BP:</strong> <span id="meanOut">â€“</span></div>
</main>

<script>
(function(){
  const tbody=document.getElementById("tbody");
  const meanOut=document.getElementById("meanOut");
  const useBtn=document.getElementById("useBtn");

  function addRow(s="",d=""){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${tbody.children.length+1}</td>
      <td><input class="sys" value="${s}"></td>
      <td><input class="dia" value="${d}"></td>`;
    tbody.appendChild(tr);
  }

  function parse(text){
    return [...text.matchAll(/(\d{2,3})\s*[/\s]\s*(\d{2,3})/g)]
      .map(m=>({s:+m[1],d:+m[2]}))
      .filter(v=>v.s>=90&&v.s<=250&&v.d>=50&&v.d<=150);
  }

  document.getElementById("parsePasteBtn").onclick=()=>{
    parse(document.getElementById("bpPaste").value).forEach(v=>addRow(v.s,v.d));
    document.getElementById("bpPaste").value="";
  };

  document.getElementById("bpImage").onchange=async e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=await Tesseract.recognize(f,'eng');
    parse(r.data.text).forEach(v=>addRow(v.s,v.d));
  };

  document.getElementById("calcBtn").onclick=()=>{
    const sys=[...document.querySelectorAll(".sys")].map(i=>+i.value);
    const dia=[...document.querySelectorAll(".dia")].map(i=>+i.value);
    const ms=Math.round(sys.reduce((a,b)=>a+b,0)/sys.length);
    const md=Math.round(dia.reduce((a,b)=>a+b,0)/dia.length);
    meanOut.textContent=`${ms}/${md}`;
    useBtn.disabled=false;
    useBtn.dataset.bp=`${ms}/${md}`;
  };

  useBtn.onclick=()=>{
    sessionStorage.setItem("hypertension_bp_value", useBtn.dataset.bp);
    window.location.href="index.html";
  };

  for(let i=0;i<4;i++) addRow();
})();
</script>
</body>
</html>
