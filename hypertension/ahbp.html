<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home / Ambulatory BP calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<!-- OCR fallback (printed text). Handwritten charts should use AI extraction (planned). -->
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
main{max-width:1000px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:.5rem;vertical-align:top}
input,textarea{width:100%;box-sizing:border-box}
.status{font-size:.9rem;margin:.4rem 0}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0;align-items:center}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ccc;font-size:.85rem}
.gridWrap{overflow:auto}
.bpCell{min-width:110px}
.dayCell{width:70px;font-weight:600}
.smallNote{font-size:.9rem;color:#333;margin:.4rem 0 .8rem}
hr{border:none;border-top:1px solid #eee;margin:1rem 0}
.extractedBox{border:1px solid #eee;border-radius:8px;padding:.8rem;background:#fafafa}
.extractedList{margin:.4rem 0 0;padding-left:1.2rem;max-height:180px;overflow:auto}
.extractedList li{margin:.15rem 0}
.kbd{display:inline-block;border:1px solid #ddd;border-bottom-color:#bbb;border-radius:6px;padding:1px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:.85em;background:#fff}
.invalid{outline:2px solid #d33;outline-offset:1px}
</style>
</head>
<body>
<header>
  <h1>Home / Ambulatory BP calculator</h1>
  <p class="subtitle">Enter readings in the table below (NICE-style). You can also paste readings or upload a photo to extract readings into a staging list, then insert into the table.</p>
  <a href="index.html" class="return-home">Back to Hypertension module</a>
</header>

<main>

  <div class="smallNote">
    <strong>How to use:</strong>
    1) Add readings to the table (format <span class="kbd">135/78</span>).
    2) Day 1 is excluded from the mean.
    3) Click <strong>Calculate mean</strong>, then <strong>Use mean BP</strong> to send it back to the hypertension module.
  </div>

  <div class="gridWrap">
    <table id="ahbpTable" aria-label="AHBPM table">
      <thead>
        <tr>
          <th class="dayCell">Day</th>
          <th>AM (1)</th>
          <th>AM (2)</th>
          <th>PM (1)</th>
          <th>PM (2)</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="status"><strong>Mean BP (Days 2–7):</strong> <span id="meanOut">–</span> <span id="validityOut"></span></div>

  <div class="actions">
    <button id="calcBtn">Calculate mean</button>
    <button id="useBtn" class="secondary" disabled>Use mean BP</button>
    <span class="pill" id="countPill">0 used</span>
    <button id="clearTableBtn" class="secondary">Clear table</button>
  </div>

  <hr>

  <div class="extractedBox">
    <h3 style="margin:.2rem 0 .4rem;">Extracted readings (staging list)</h3>
    <div class="smallNote" style="margin:.2rem 0 .6rem;">
      Paste or upload a photo to extract BP pairs into this list. Then click <strong>Insert into table</strong>.
      (Handwritten charts: OCR may miss values — AI extraction is planned.)
    </div>

    <label><strong>Paste readings</strong></label>
    <textarea id="bulkPaste" rows="3" placeholder="e.g. 132/82, 128/80, 135/84&#10;or: Mon AM 132/82 128/80; Mon PM 140/86"></textarea>
    <div class="actions" style="margin-top:.5rem;">
      <button id="parsePasteBtn" class="secondary">Extract from paste</button>
      <button id="clearExtractedBtn" class="secondary">Clear extracted list</button>
      <span class="pill" id="extractedPill">0 extracted</span>
    </div>

    <label style="margin-top:.6rem;"><strong>Upload BP image (beta OCR)</strong></label>
    <input type="file" id="bpImage" accept="image/*">
    <div class="status" id="ocrStatus"></div>

    <div class="actions">
      <button id="insertBtn">Insert into table</button>
      <button id="clearAllBtn" class="secondary">Clear everything</button>
    </div>

    <ol class="extractedList" id="extractedList"></ol>
  </div>

</main>

<script>
(function(){
  const SLOTS = ["AM1","AM2","PM1","PM2"];
  const tableBody = document.getElementById("tableBody");
  const meanOut = document.getElementById("meanOut");
  const validityOut = document.getElementById("validityOut");
  const useBtn = document.getElementById("useBtn");
  const countPill = document.getElementById("countPill");

  const extracted = []; // array of "SYS/DIA" strings
  const extractedList = document.getElementById("extractedList");
  const extractedPill = document.getElementById("extractedPill");
  const ocrStatus = document.getElementById("ocrStatus");

  function buildTable(){
    tableBody.innerHTML = "";
    for(let day=1; day<=7; day++){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="dayCell">${day}</td>
        ${SLOTS.map((slot,idx)=>`
          <td>
            <input class="bpCell" data-day="${day}" data-slot="${slot}" placeholder="e.g. 135/78" inputmode="numeric">
          </td>
        `).join("")}
      `;
      tableBody.appendChild(tr);
    }
    // attach validation handlers
    document.querySelectorAll(".bpCell").forEach(inp=>{
      inp.addEventListener("blur", ()=>validateCell(inp));
      inp.addEventListener("input", ()=>{ inp.classList.remove("invalid"); });
    });
  }

  function normalizeBP(text){
    if(!text) return "";
    // allow 135/78, 135 / 78, 135-78, 135\78 etc
    const m = String(text).trim().match(/(\d{2,3})\s*[^\d]{0,3}\s*(\d{2,3})/);
    if(!m) return "";
    const s = parseInt(m[1],10), d = parseInt(m[2],10);
    if(!(s>=90 && s<=250 && d>=50 && d<=150)) return "";
    return `${s}/${d}`;
  }

  function validateCell(inp){
    const v = inp.value.trim();
    if(!v){ inp.classList.remove("invalid"); return true; }
    const n = normalizeBP(v);
    if(!n){ inp.classList.add("invalid"); return false; }
    inp.value = n;
    inp.classList.remove("invalid");
    return true;
  }

  function parsePairs(text){
    const rx = /(\d{2,3})\s*[^\d]{0,6}\s*(\d{2,3})/g;
    const out = [];
    let m;
    while((m = rx.exec(text)) !== null){
      const s = parseInt(m[1],10), d = parseInt(m[2],10);
      if(s>=90 && s<=250 && d>=50 && d<=150) out.push(`${s}/${d}`);
    }
    return out;
  }

  function renderExtracted(){
    extractedList.innerHTML = "";
    extracted.forEach((bp, i)=>{
      const li = document.createElement("li");
      li.innerHTML = `${bp} <button class="secondary" data-i="${i}" style="margin-left:.5rem;">Remove</button>`;
      li.querySelector("button").onclick = (e)=>{
        const idx = parseInt(e.target.getAttribute("data-i"),10);
        extracted.splice(idx,1);
        renderExtracted();
      };
      extractedList.appendChild(li);
    });
    extractedPill.textContent = `${extracted.length} extracted`;
  }

  function allTableInputsInOrder(){
    // day 1..7, slots AM1 AM2 PM1 PM2
    const inputs = [];
    for(let day=1; day<=7; day++){
      for(const slot of SLOTS){
        inputs.push(document.querySelector(`.bpCell[data-day="${day}"][data-slot="${slot}"]`));
      }
    }
    return inputs.filter(Boolean);
  }

  function insertExtractedIntoTable(){
    if(!extracted.length) return;
    const inputs = allTableInputsInOrder();
    let used = 0;
    for(const inp of inputs){
      if(!extracted.length) break;
      if(inp.value.trim()) continue; // don't overwrite
      const bp = extracted.shift();
      inp.value = bp;
      validateCell(inp);
      used++;
    }
    if(used===0 && extracted.length){
      // table full
      ocrStatus.textContent = "Table is full — clear some cells to insert more.";
    } else if(used>0){
      ocrStatus.textContent = `Inserted ${used} reading${used===1?"":"s"} into the table. Please review.`;
    }
    renderExtracted();
  }

  function getUsedVals(){
    // NICE: exclude Day 1. Use Days 2–7.
    const vals = [];
    for(let day=2; day<=7; day++){
      for(const slot of SLOTS){
        const inp = document.querySelector(`.bpCell[data-day="${day}"][data-slot="${slot}"]`);
        if(!inp) continue;
        if(!validateCell(inp)) continue;
        const v = normalizeBP(inp.value);
        if(!v) continue;
        const parts = v.split("/");
        vals.push({ s: parseInt(parts[0],10), d: parseInt(parts[1],10) });
      }
    }
    return vals;
  }

  function updateUsedCount(){
    const vals = getUsedVals();
    countPill.textContent = `${vals.length} used`;
    return vals.length;
  }

  document.getElementById("parsePasteBtn").onclick = ()=>{
    const t = document.getElementById("bulkPaste").value || "";
    const vals = parsePairs(t);
    if(!vals.length){
      ocrStatus.textContent = "No BP pairs found in pasted text.";
      return;
    }
    extracted.push(...vals);
    ocrStatus.textContent = `Extracted ${vals.length} reading${vals.length===1?"":"s"} from paste.`;
    renderExtracted();
  };

  document.getElementById("clearExtractedBtn").onclick = ()=>{
    extracted.length = 0;
    renderExtracted();
    ocrStatus.textContent = "";
  };

  document.getElementById("insertBtn").onclick = ()=>{
    insertExtractedIntoTable();
  };

  document.getElementById("clearTableBtn").onclick = ()=>{
    document.querySelectorAll(".bpCell").forEach(inp=>{ inp.value=""; inp.classList.remove("invalid"); });
    meanOut.textContent = "–";
    validityOut.textContent = "";
    useBtn.disabled = true;
    updateUsedCount();
  };

  document.getElementById("clearAllBtn").onclick = ()=>{
    document.getElementById("clearTableBtn").click();
    document.getElementById("clearExtractedBtn").click();
    document.getElementById("bulkPaste").value = "";
    document.getElementById("bpImage").value = "";
    ocrStatus.textContent = "";
  };

  document.getElementById("bpImage").onchange = async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    ocrStatus.textContent = "Reading image… (OCR, may take 10–30s)";
    try{
      const r = await Tesseract.recognize(f, "eng", {
        logger: m=>{
          if(m.status && typeof m.progress==="number"){
            ocrStatus.textContent = `Reading image… ${Math.round(m.progress*100)}%`;
          }
        }
      });
      const vals = parsePairs((r && r.data && r.data.text) ? r.data.text : "");
      if(!vals.length){
        ocrStatus.textContent = "No BP pairs detected — try pasting readings instead.";
      } else {
        extracted.push(...vals);
        ocrStatus.textContent = `Extracted ${vals.length} reading${vals.length===1?"":"s"} from image. Please review and insert into the table.`;
      }
      renderExtracted();
    }catch(err){
      ocrStatus.textContent = "Image OCR failed in this browser — try pasting readings instead.";
    }
  };

  document.getElementById("calcBtn").onclick = ()=>{
    const vals = getUsedVals();
    countPill.textContent = `${vals.length} used`;
    if(!vals.length){
      meanOut.textContent = "–";
      validityOut.textContent = "";
      useBtn.disabled = true;
      return;
    }
    const ms = Math.round(vals.reduce((a,v)=>a+v.s,0) / vals.length);
    const md = Math.round(vals.reduce((a,v)=>a+v.d,0) / vals.length);
    meanOut.textContent = `${ms}/${md} mmHg`;
    const ok = vals.length >= 12;
    validityOut.textContent = ok ? ` (valid: ${vals.length} readings)` : ` (low count: ${vals.length} readings)`;
    useBtn.disabled = false;
    useBtn.dataset.bp = `${ms}/${md}`;
  };

  useBtn.onclick = ()=>{
    if(!useBtn.dataset.bp) return;
    sessionStorage.setItem("hypertension_bp_value", useBtn.dataset.bp);
    sessionStorage.setItem("hypertension_bp_type", "home");
    window.location.href = "index.html";
  };

  // init
  buildTable();
  renderExtracted();
  updateUsedCount();
})();
</script>

</body>
</html>
