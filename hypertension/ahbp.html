<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AHBP / HBPM calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<style>
main{max-width:900px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
input{width:100%;box-sizing:border-box}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--nhs-border,#ccc);font-size:.8rem;background:#fff}
</style>
</head>
<body>
<header>
<h1>AHBP / HBPM calculator</h1>
<p class="subtitle">Calculate mean home BP and send to Hypertension module</p>
<a href="index.html" class="return-home">Back to Hypertension module</a>
</header>
<main>
<p class="hint">Enter readings (morning/evening). Blank rows are ignored.</p>
<div class="actions">
  <button id="addRowBtn" class="secondary">Add row</button>
  <button id="calcBtn">Calculate mean</button>
  <button id="useBtn" class="secondary" disabled>Use mean BP in module</button>
  <span class="pill" id="countPill">0 readings</span>
</div>
<table id="bpTable">
  <thead><tr><th>#</th><th>Systolic</th><th>Diastolic</th><th>Notes</th></tr></thead>
  <tbody></tbody>
</table>
<div style="margin-top:.8rem">
  <div><strong>Mean BP:</strong> <span id="meanOut">–</span></div>
  <div><strong>Status:</strong> <span id="interpOut">–</span></div>
</div>
</main>
<script>
(function(){
  const tbody=document.querySelector("#bpTable tbody");
  const meanOut=document.getElementById("meanOut");
  const interpOut=document.getElementById("interpOut");
  const useBtn=document.getElementById("useBtn");
  const countPill=document.getElementById("countPill");

  function addRow(){
    const idx=tbody.children.length+1;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${idx}</td>
      <td><input inputmode="numeric" class="sys" placeholder="e.g. 132"></td>
      <td><input inputmode="numeric" class="dia" placeholder="e.g. 82"></td>
      <td><input placeholder="optional"></td>`;
    tbody.appendChild(tr);
  }

  function readVals(){
    const sys=[...document.querySelectorAll(".sys")];
    const dia=[...document.querySelectorAll(".dia")];
    const vals=[];
    for(let i=0;i<sys.length;i++){
      const s=parseFloat(sys[i].value);
      const d=parseFloat(dia[i].value);
      if(!isNaN(s) && !isNaN(d)) vals.push({s,d});
    }
    return vals;
  }

  function calc(){
    const vals=readVals();
    countPill.textContent=`${vals.length} readings`;
    if(!vals.length){
      meanOut.textContent="–";
      interpOut.textContent="Enter at least one valid systolic + diastolic pair.";
      useBtn.disabled=true;
      return;
    }
    const ms=Math.round(vals.reduce((a,v)=>a+v.s,0)/vals.length);
    const md=Math.round(vals.reduce((a,v)=>a+v.d,0)/vals.length);
    meanOut.textContent=`${ms}/${md} mmHg`;
    interpOut.textContent="Mean calculated. Click “Use mean BP in module” to populate the main page.";
    useBtn.disabled=false;
    useBtn.dataset.bp=`${ms}/${md}`;
  }

  document.getElementById("addRowBtn").addEventListener("click", addRow);
  document.getElementById("calcBtn").addEventListener("click", calc);
  useBtn.addEventListener("click", ()=>{
    const bp=useBtn.dataset.bp;
    if(!bp) return;
    sessionStorage.setItem("hypertension_bp_value", bp);
    sessionStorage.setItem("hypertension_bp_type", "home");
    window.location.href="index.html";
  });

  for(let i=0;i<12;i++) addRow();
})();
</script>
</body>
</html>
