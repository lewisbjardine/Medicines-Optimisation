<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home / Ambulatory BP calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<style>
main{max-width:900px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
textarea{width:100%;box-sizing:border-box}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0}
.status{font-size:.85rem;margin:.4rem 0}
table{width:100%;border-collapse:collapse;margin-top:1rem}
th,td{border:1px solid #ddd;padding:.4rem;text-align:center}
th{background:#f6f6f6}
details{margin-top:1rem}
</style>
</head>

<body>
<header>
  <h1>Home / Ambulatory BP calculator</h1>
  <p class="subtitle">Paste readings or upload a photo. Please check values before calculating.</p>
  <a href="index.html" class="return-home">Back to Hypertension module</a>
</header>

<main>

<!-- IMAGE INPUT -->
<label><strong>Upload BP image (optional)</strong></label>
<input type="file" id="bpImage" accept="image/*">
<button id="aiInterpretBtn" class="secondary">Interpret image with AI</button>
<div class="status" id="imageStatus"></div>

<!-- FREE TEXT INPUT -->
<label style="margin-top:1rem;"><strong>BP readings (single source of truth)</strong></label>
<textarea id="bpText"
  rows="6"
  placeholder="Enter or paste readings, e.g.
135/78
140/82
132/76"></textarea>

<!-- ACTIONS -->
<div class="actions">
  <button id="calcBtn">Calculate mean</button>
  <button id="useBtn" class="secondary" disabled>Use mean BP</button>
</div>

<div class="status">
  <strong>Mean BP:</strong>
  <span id="meanOut">–</span>
</div>

<!-- OPTIONAL NICE TABLE -->
<details>
  <summary><strong>Optional NICE AHBPM review table (manual only)</strong></summary>

  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>AM 1</th>
        <th>AM 2</th>
        <th>PM 1</th>
        <th>PM 2</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>1</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>2</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>3</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>4</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>5</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>6</td><td></td><td></td><td></td><td></td></tr>
      <tr><td>7</td><td></td><td></td><td></td><td></td></tr>
    </tbody>
  </table>
</details>

</main>

<script>
/* ============================================================
   GEMINI CONFIG – SEARCH AND REPLACE THIS VALUE
   ============================================================ */

const GEMINI_API_KEY = "AIzaSyCUqAG5w8XbIsOt0pBiNm36o-S0UOcJd7g";
const GEMINI_MODEL = "gemini-1.5-pro-vision";

/* ============================================================
   GEMINI PROMPT
   ============================================================ */

const GEMINI_PROMPT = `
You are a clinical assistant.

This image shows home or ambulatory blood pressure readings.

Extract blood pressure readings only.

Rules:
- Extract only systolic/diastolic pairs (e.g. 135/78)
- Ignore dates, times, notes, headings, comments
- Do not guess unclear values
- If uncertain, omit the reading
- Do not calculate averages

Return plain text only, one reading per line, in this format:
135/78
140/82
132/76
`;

/* ============================================================
   HELPERS
   ============================================================ */

function parsePairs(text){
  const rx=/(\d{2,3})\s*\/\s*(\d{2,3})/g;
  const out=[];
  let m;
  while((m=rx.exec(text))!==null){
    const s=+m[1], d=+m[2];
    if(s>=90&&s<=250&&d>=50&&d<=150){
      out.push({s,d});
    }
  }
  return out;
}

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result.split(",")[1]);
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

async function interpretImageWithGemini(file){
  const b64=await fileToBase64(file);

  const res=await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        contents:[{
          parts:[
            { text:GEMINI_PROMPT },
            { inlineData:{ mimeType:file.type, data:b64 } }
          ]
        }]
      })
    }
  );

  if(!res.ok) throw new Error("Gemini request failed");
  const json=await res.json();
  const txt=json.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!txt) throw new Error("No text returned");
  return txt.trim();
}

/* ============================================================
   UI WIRING
   ============================================================ */

const bpText=document.getElementById("bpText");
const meanOut=document.getElementById("meanOut");
const useBtn=document.getElementById("useBtn");
const imageStatus=document.getElementById("imageStatus");

document.getElementById("calcBtn").onclick=()=>{
  const vals=parsePairs(bpText.value);
  if(!vals.length){
    meanOut.textContent="–";
    useBtn.disabled=true;
    return;
  }
  const ms=Math.round(vals.reduce((a,v)=>a+v.s,0)/vals.length);
  const md=Math.round(vals.reduce((a,v)=>a+v.d,0)/vals.length);
  meanOut.textContent=`${ms}/${md} mmHg (n=${vals.length})`;
  useBtn.disabled=false;
  useBtn.dataset.bp=`${ms}/${md}`;
};

useBtn.onclick=()=>{
  sessionStorage.setItem("hypertension_bp_value", useBtn.dataset.bp);
  sessionStorage.setItem("hypertension_bp_type","home");
  window.location.href="index.html";
};

document.getElementById("aiInterpretBtn").onclick=async()=>{
  const fileInput=document.getElementById("bpImage");
  if(!fileInput.files.length){
    alert("Please select an image first");
    return;
  }
  imageStatus.textContent="Interpreting image with AI…";

  try{
    const extracted=await interpretImageWithGemini(fileInput.files[0]);
    bpText.value = bpText.value.trim()
      ? bpText.value.trim() + "\n" + extracted
      : extracted;
    imageStatus.textContent="AI extracted BP readings. Please check before calculating.";
  }catch(err){
    console.error(err);
    imageStatus.textContent="AI interpretation failed. Please enter readings manually.";
  }
};
</script>

</body>
</html>
