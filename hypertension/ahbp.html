<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home / Ambulatory BP calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<!-- OCR fallback for printed text only. Handwritten charts should use AI vision (Gemini) via a private endpoint. -->
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
main{max-width:1000px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:.5rem;vertical-align:top}
input,textarea{width:100%;box-sizing:border-box}
.status{font-size:.9rem;margin:.4rem 0}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0;align-items:center}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ccc;font-size:.85rem}
.gridWrap{overflow:auto}
.bpCell{min-width:110px}
.dayCell{width:70px;font-weight:600}
.smallNote{font-size:.95rem;color:#333;margin:.4rem 0 .8rem}
hr{border:none;border-top:1px solid #eee;margin:1rem 0}
.kbd{display:inline-block;border:1px solid #ddd;border-bottom-color:#bbb;border-radius:6px;padding:1px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:.85em;background:#fff}
.invalid{outline:2px solid #d33;outline-offset:1px}
</style>
</head>
<body>
<header>
  <h1>Home / Ambulatory BP calculator</h1>
  <p class="subtitle">Paste readings or upload a photo to extract readings, then calculate a mean home BP. (Optional NICE table below for structured review.)</p>
  <a href="index.html" class="return-home">Back to Hypertension module</a>
</header>

<main>

  <div class="smallNote">
    <strong>How to use:</strong>
    Paste readings (format like <span class="kbd">135/78</span>) or upload a photo. Click <strong>Calculate mean</strong>, then <strong>Use mean BP</strong> to send it back to the hypertension module.
  </div>

  <label><strong>Paste BP readings</strong></label>
  <textarea id="bulkPaste" rows="4" placeholder="e.g. 132/82, 128/80, 135/84&#10;or: Mon AM 132/82 128/80; Mon PM 140/86"></textarea>

  <div class="actions" style="margin-top:.5rem;">
    <button id="calcTextBtn">Calculate mean</button>
    <button id="useBtn" class="secondary" disabled>Use mean BP</button>
    <span class="pill" id="countPill">0 readings</span>
    <button id="clearTextBtn" class="secondary">Clear text</button>
  </div>

  <label style="margin-top:.6rem;"><strong>Upload BP image (beta OCR)</strong></label>
  <input type="file" id="bpImage" accept="image/*">
  <div class="status" id="ocrStatus"></div>

  <div class="status"><strong>Mean BP:</strong> <span id="meanOut">–</span> <span id="validityOut"></span></div>

  <hr>

  <details>
    <summary><strong>Optional NICE-style table (manual entry / review)</strong></summary>
    <div class="smallNote" style="margin-top:.6rem;">
      This table matches the patient paper template (7 days; AM(1), AM(2), PM(1), PM(2)). Day 1 is excluded from the NICE mean.
      The table is <strong>not</strong> auto-populated from paste or image.
    </div>

    <div class="gridWrap">
      <table id="ahbpTable" aria-label="AHBPM table">
        <thead>
          <tr>
            <th class="dayCell">Day</th>
            <th>AM (1)</th>
            <th>AM (2)</th>
            <th>PM (1)</th>
            <th>PM (2)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="actions">
      <button id="calcTableBtn" class="secondary">Calculate NICE mean (Days 2–7)</button>
      <span class="pill" id="tableCountPill">0 used</span>
      <button id="clearTableBtn" class="secondary">Clear table</button>
    </div>
  </details>

</main>

<script>
(function(){
  const SLOTS = ["AM1","AM2","PM1","PM2"];
  const meanOut = document.getElementById("meanOut");
  const validityOut = document.getElementById("validityOut");
  const useBtn = document.getElementById("useBtn");
  const countPill = document.getElementById("countPill");
  const ocrStatus = document.getElementById("ocrStatus");
  const bulkPaste = document.getElementById("bulkPaste");

  const tableBody = document.getElementById("tableBody");
  const tableCountPill = document.getElementById("tableCountPill");

  function parsePairs(text){
    const rx = /(\d{2,3})\s*[^\d]{0,6}\s*(\d{2,3})/g;
    const out = [];
    let m;
    while((m = rx.exec(text)) !== null){
      const s = parseInt(m[1],10), d = parseInt(m[2],10);
      if(s>=90 && s<=250 && d>=50 && d<=150) out.push({s,d,txt:`${s}/${d}`});
    }
    return out;
  }

  function setMean(ms, md, n, note){
    if(!n){
      meanOut.textContent = "–";
      validityOut.textContent = "";
      countPill.textContent = "0 readings";
      useBtn.disabled = true;
      delete useBtn.dataset.bp;
      if(note) ocrStatus.textContent = note;
      return;
    }
    meanOut.textContent = `${ms}/${md} mmHg`;
    countPill.textContent = `${n} reading${n===1?"":"s"}`;
    // Validity note is just about count here (unstructured). NICE validity is available in table mode.
    validityOut.textContent = n >= 12 ? ` (n=${n})` : ` (low count: n=${n})`;
    useBtn.disabled = false;
    useBtn.dataset.bp = `${ms}/${md}`;
    if(note) ocrStatus.textContent = note;
  }

  function calcMeanFromText(){
    const vals = parsePairs(bulkPaste.value || "");
    if(!vals.length){
      setMean(null,null,0,"No BP pairs found.");
      return;
    }
    const ms = Math.round(vals.reduce((a,v)=>a+v.s,0) / vals.length);
    const md = Math.round(vals.reduce((a,v)=>a+v.d,0) / vals.length);
    setMean(ms, md, vals.length, `Calculated mean from ${vals.length} reading${vals.length===1?"":"s"}.`);
  }

  document.getElementById("calcTextBtn").onclick = ()=>calcMeanFromText();

  document.getElementById("clearTextBtn").onclick = ()=>{
    bulkPaste.value = "";
    setMean(null,null,0,"");
    ocrStatus.textContent = "";
    document.getElementById("bpImage").value = "";
  };

  // OCR: extract pairs and append to the same text box, then calculate mean (same pathway as paste)
  document.getElementById("bpImage").onchange = async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    ocrStatus.textContent = "Reading image… (OCR, may take 10–30s)";
    try{
      const r = await Tesseract.recognize(f, "eng", {
        logger: m=>{
          if(m.status && typeof m.progress==="number"){
            ocrStatus.textContent = `Reading image… ${Math.round(m.progress*100)}%`;
          }
        }
      });
      const vals = parsePairs((r && r.data && r.data.text) ? r.data.text : "");
      if(!vals.length){
        ocrStatus.textContent = "No BP pairs detected — try pasting readings instead.";
        return;
      }
      // append extracted readings to textarea (one per line) without overwriting existing text
      const existing = (bulkPaste.value || "").trim();
      const add = vals.map(v=>v.txt).join("\n");
      bulkPaste.value = existing ? (existing + "\n" + add) : add;
      calcMeanFromText();
      ocrStatus.textContent = `Extracted ${vals.length} reading${vals.length===1?"":"s"} from image into the text box. Please verify then use Calculate mean.`;
    }catch(err){
      ocrStatus.textContent = "Image OCR failed in this browser — try pasting readings instead.";
    }
  };

  useBtn.onclick = ()=>{
    if(!useBtn.dataset.bp) return;
    sessionStorage.setItem("hypertension_bp_value", useBtn.dataset.bp);
    sessionStorage.setItem("hypertension_bp_type", "home");
    window.location.href = "index.html";
  };

  // ---- Optional NICE table (manual) ----
  function buildTable(){
    if(!tableBody) return;
    tableBody.innerHTML = "";
    for(let day=1; day<=7; day++){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="dayCell">${day}</td>
        ${SLOTS.map(slot=>`
          <td><input class="bpCell" data-day="${day}" data-slot="${slot}" placeholder="e.g. 135/78" inputmode="numeric"></td>
        `).join("")}
      `;
      tableBody.appendChild(tr);
    }
    document.querySelectorAll(".bpCell").forEach(inp=>{
      inp.addEventListener("blur", ()=>validateCell(inp));
      inp.addEventListener("input", ()=>{ inp.classList.remove("invalid"); });
    });
    updateTableCount();
  }

  function normalizeBP(text){
    if(!text) return "";
    const m = String(text).trim().match(/(\d{2,3})\s*[^\d]{0,3}\s*(\d{2,3})/);
    if(!m) return "";
    const s = parseInt(m[1],10), d = parseInt(m[2],10);
    if(!(s>=90 && s<=250 && d>=50 && d<=150)) return "";
    return `${s}/${d}`;
  }

  function validateCell(inp){
    const v = inp.value.trim();
    if(!v){ inp.classList.remove("invalid"); return true; }
    const n = normalizeBP(v);
    if(!n){ inp.classList.add("invalid"); return false; }
    inp.value = n;
    inp.classList.remove("invalid");
    return true;
  }

  function getNICEVals(){
    const vals = [];
    for(let day=2; day<=7; day++){
      for(const slot of SLOTS){
        const inp = document.querySelector(`.bpCell[data-day="${day}"][data-slot="${slot}"]`);
        if(!inp) continue;
        if(!validateCell(inp)) continue;
        const v = normalizeBP(inp.value);
        if(!v) continue;
        const parts = v.split("/");
        vals.push({ s: parseInt(parts[0],10), d: parseInt(parts[1],10) });
      }
    }
    return vals;
  }

  function updateTableCount(){
    if(!tableCountPill) return 0;
    const n = getNICEVals().length;
    tableCountPill.textContent = `${n} used`;
    return n;
  }

  const calcTableBtn = document.getElementById("calcTableBtn");
  if(calcTableBtn){
    calcTableBtn.onclick = ()=>{
      const vals = getNICEVals();
      updateTableCount();
      if(!vals.length){
        ocrStatus.textContent = "No valid readings in table (Days 2–7).";
        return;
      }
      const ms = Math.round(vals.reduce((a,v)=>a+v.s,0) / vals.length);
      const md = Math.round(vals.reduce((a,v)=>a+v.d,0) / vals.length);
      setMean(ms, md, vals.length, `Calculated NICE mean from table (Days 2–7), n=${vals.length}.`);
    };
  }

  const clearTableBtn = document.getElementById("clearTableBtn");
  if(clearTableBtn){
    clearTableBtn.onclick = ()=>{
      document.querySelectorAll(".bpCell").forEach(inp=>{ inp.value=""; inp.classList.remove("invalid"); });
      updateTableCount();
    };
  }

  buildTable();
})();
</script>

</body>
</html>
