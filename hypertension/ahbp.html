<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home / Ambulatory BP calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
main{max-width:900px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:.4rem}
input,textarea{width:100%;box-sizing:border-box}
.status{font-size:.85rem;margin:.4rem 0}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.8rem 0}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ccc;font-size:.8rem}
</style>
</head>
<body>
<header>
<h1>Home / Ambulatory BP calculator</h1>
<p class="subtitle">Paste readings or upload an image. Please verify extracted values.</p>
<a href="index.html" class="return-home">Back to Hypertension module</a>
</header>

<main>
<label style="margin-top:1rem;"><strong>Upload BP image (beta)</strong></label>
<input type="file" id="bpImage" accept="image/*">
<div class="status" id="ocrStatus"></div>

<div class="actions">
  <button id="addRowBtn" class="secondary">Add row</button>
  <button id="clearRowsBtn" class="secondary">Clear all</button>
</div>
<label style="margin-top:.6rem;"><strong>Paste BP readings</strong></label>
<textarea id="bulkPaste" rows="3" placeholder="e.g. 132/82, 128/80, 135/84"></textarea>
<button id="parsePasteBtn" class="secondary">Add pasted readings</button>

<div class="actions">
  <button id="calcBtn">Calculate mean</button>
  <button id="useBtn" class="secondary" disabled>Use mean BP</button>
  <span class="pill" id="countPill">0 readings</span>
</div>

<table>
<thead><tr><th>#</th><th>Systolic</th><th>Diastolic</th><th></th></tr></thead>
<tbody id="tbody"></tbody>
</table>

<div class="status"><strong>Mean BP:</strong> <span id="meanOut">–</span></div>
</main>

<script>
(function(){
  const tbody=document.getElementById("tbody");
  const meanOut=document.getElementById("meanOut");
  const useBtn=document.getElementById("useBtn");
  const status=document.getElementById("ocrStatus");
  const countPill=document.getElementById("countPill");

  function addRow(s="",d=""){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${tbody.children.length+1}</td>
      <td><input class="sys" inputmode="numeric" value="${s}"></td>
      <td><input class="dia" inputmode="numeric" value="${d}"></td>
      <td><button class="secondary delBtn">✕</button></td>`;
    tr.querySelector(".delBtn").onclick=()=>{
      tr.remove();
      renumber();
      updateCount();
    };
    tbody.appendChild(tr);
  }

  function renumber(){
    [...tbody.children].forEach((tr,i)=>tr.firstChild.textContent=i+1);
  }

  function parsePairs(text){
    const rx=/(\d{2,3})\D{0,10}(\d{2,3})/g;
    const out=[];
    let m;
    while((m=rx.exec(text))!==null){
      const s=+m[1], d=+m[2];
      if(s>=90&&s<=250&&d>=50&&d<=150) out.push({s,d});
    }
    return out;
  }

  function getVals(){
    const vals=[];
    for(const r of [...tbody.querySelectorAll("tr")]){
      const sTxt=(r.querySelector(".sys")?.value||"").trim();
      const dTxt=(r.querySelector(".dia")?.value||"").trim();
      if(!sTxt || !dTxt) continue;
      const s=parseFloat(sTxt), d=parseFloat(dTxt);
      if(isNaN(s)||isNaN(d)) continue;
      vals.push({s,d});
    }
    return vals;
  }

  function updateCount(){
    countPill.textContent=`${getVals().length} readings`;
  }

  document.getElementById("parsePasteBtn").onclick=()=>{
    const t=document.getElementById("bulkPaste").value||"";
    const vals=parsePairs(t);
    vals.forEach(v=>addRow(v.s,v.d));
    updateCount();
  };

  document.getElementById("addRowBtn").onclick=()=>{
    addRow();
    updateCount();
  };

  document.getElementById("clearRowsBtn").onclick=()=>{
    tbody.innerHTML="";
    updateCount();
    meanOut.textContent="–";
    useBtn.disabled=true;
  };

  document.getElementById("bpImage").onchange=async e=>{
    const f=e.target.files[0]; if(!f) return;
    status.textContent="Reading image… (may take 10–30s)";
    try{
      const r=await Tesseract.recognize(f,'eng',{
        logger:m=>{
          if(m.status && typeof m.progress==='number'){
            status.textContent=`Reading image… ${Math.round(m.progress*100)}%`;
          }
        }
      });
      const vals=parsePairs(r.data.text||"");
      if(!vals.length){
        status.textContent="No BP pairs detected — try a clearer image or paste readings instead.";
      } else {
        vals.forEach(v=>addRow(v.s,v.d));
        status.textContent="Image processed — please check values.";
      }
    }catch(err){
      status.textContent="Image OCR failed in this browser — try pasting readings instead.";
    }
    updateCount();
  };

  document.getElementById("calcBtn").onclick=()=>{
    const vals=getVals();
    updateCount();
    if(!vals.length) return;
    const ms=Math.round(vals.reduce((a,v)=>a+v.s,0)/vals.length);
    const md=Math.round(vals.reduce((a,v)=>a+v.d,0)/vals.length);
    meanOut.textContent=`${ms}/${md} mmHg`;
    useBtn.disabled=false;
    useBtn.dataset.bp=`${ms}/${md}`;
  };

  useBtn.onclick=()=>{
    sessionStorage.setItem("hypertension_bp_value", useBtn.dataset.bp);
    sessionStorage.setItem("hypertension_bp_type","home");
    window.location.href="index.html";
  };
})();
</script>

</body>
</html>
