<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AHBP / HBPM calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../shared/styles.css">
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
main{max-width:900px;margin:1.2rem auto;padding:1rem;background:#fff;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:.4rem}
input,textarea{width:100%}
.status{font-size:.85rem;margin:.4rem 0}
</style>
</head>
<body>
<header>
<h1>Home / Ambulatory BP calculator</h1>
<p class="subtitle">Paste readings or upload an image. Please verify extracted values.</p>
<a href="index.html" class="return-home">Back to Hypertension module</a>
</header>

<main>

<label><strong>Add readings from pasted text</strong></label>
<textarea id="bpPaste" rows="4" placeholder="e.g. 132/82, 128 80, AM 134/84"></textarea>
<button id="pasteBtn">Add readings</button>

<label style="margin-top:1rem;"><strong>Upload BP image (beta)</strong></label>
<input type="file" id="bpImage" accept="image/*">
<div class="status" id="ocrStatus"></div>

<button id="calcBtn">Calculate mean</button>
<button id="useBtn" disabled>Use mean BP</button>

<table>
<thead><tr><th>#</th><th>Systolic</th><th>Diastolic</th></tr></thead>
<tbody id="tbody"></tbody>
</table>

<div class="status"><strong>Mean BP:</strong> <span id="meanOut">–</span></div>

</main>

<script>
(function(){
  const tbody=document.getElementById("tbody");
  const meanOut=document.getElementById("meanOut");
  const useBtn=document.getElementById("useBtn");
  const status=document.getElementById("ocrStatus");

  function addRow(s="",d=""){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${tbody.children.length+1}</td>
      <td><input class="sys" value="${s}"></td>
      <td><input class="dia" value="${d}"></td>`;
    tbody.appendChild(tr);
  }

  function extract(text){
    const out=[];
    const rx=/(\d{2,3})\D{0,6}(\d{2,3})/g;
    let m;
    while((m=rx.exec(text))!==null){
      const s=+m[1], d=+m[2];
      if(s>=90&&s<=250&&d>=50&&d<=150) out.push({s,d});
    }
    return out;
  }

  document.getElementById("pasteBtn").onclick=()=>{
    extract(document.getElementById("bpPaste").value).forEach(v=>addRow(v.s,v.d));
    document.getElementById("bpPaste").value="";
  };

  document.getElementById("bpImage").onchange=async e=>{
    const f=e.target.files[0]; if(!f) return;
    status.textContent="Reading image…";
    const r=await Tesseract.recognize(f,'eng');
    extract(r.data.text).forEach(v=>addRow(v.s,v.d));
    status.textContent="Image processed — please check values.";
  };

  document.getElementById("calcBtn").onclick=()=>{
    const rows=[...tbody.querySelectorAll("tr")];
    const vals=rows.map(r=>{
      const s=+r.querySelector(".sys").value;
      const d=+r.querySelector(".dia").value;
      return (!isNaN(s)&&!isNaN(d))?{s,d}:null;
    }).filter(Boolean);
    if(!vals.length) return;
    const ms=Math.round(vals.reduce((a,v)=>a+v.s,0)/vals.length);
    const md=Math.round(vals.reduce((a,v)=>a+v.d,0)/vals.length);
    meanOut.textContent=`${ms}/${md} mmHg`;
    useBtn.disabled=false;
    useBtn.dataset.bp=`${ms}/${md}`;
  };

  useBtn.onclick=()=>{
    sessionStorage.setItem("hypertension_bp_value", useBtn.dataset.bp);
    sessionStorage.setItem("hypertension_bp_type","home");
    window.location.href="index.html";
  };

  for(let i=0;i<4;i++) addRow();
})();
</script>

</body>
</html>
