<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Primary Care Drug Guidance Helper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration for NHS colours
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nhs-blue': '#005eb8',
                        'nhs-light-blue': '#e5f0f9',
                        'nhs-grey': '#425563',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles for a clean, professional NHS look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f7; /* Light background */
            color: #222;
        }
        .nhs-header {
            background-color: #005eb8;
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-top: 1rem;
        }
        .tab-button {
            border: 1px solid #005eb8;
            background: white;
            color: #005eb8;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: #005eb8;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        input, select {
            border: 1px solid #d0d0d0;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #005eb8;
            box-shadow: 0 0 0 1px #005eb8;
        }
        .grid-col-3 {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1.5rem;
        }
        @media (min-width: 640px) {
            .grid-col-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        .btn-primary {
            background-color: #005eb8;
            color: white;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #003087;
        }
        .output-box {
            background-color: #e5f0f9;
            border-left: 5px solid #005eb8;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
        }
        .output-box h3 {
            margin-top: 0;
            color: #005eb8;
            font-size: 1.125rem;
        }
        .output-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
        }
    </style>
</head>
<body>

<header class="nhs-header">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold">Primary Care Drug Guidance</h1>
        <p class="mt-1 opacity-90">Tapering, Stopping, Switching Antidepressants, Opioids, and Sedative Hypnotics (Beta)</p>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4">

    <!-- Landing Page (Default View) -->
    <section id="welcome-screen" class="card">
        <h2 class="text-xl font-semibold text-nhs-blue mb-4">Welcome, Dr. Jardine. Select a Guidance Module.</h2>
        <p class="text-sm text-nhs-grey mb-6">
            **Disclaimer:** This tool is for quick reference and educational purposes only. It is not a substitute for clinical judgement, full national guidance (e.g., SPS, NICE), or specialist advice. Always individualise patient care and check local formularies.
        </p>
        
        <div class="grid grid-col-3">
            <!-- 1. Antidepressant Module -->
            <button onclick="showModule('ad-guidance')" class="p-4 bg-nhs-light-blue hover:bg-nhs-blue/20 transition rounded-lg text-left border border-nhs-blue/30 shadow-md">
                <h3 class="font-bold text-lg text-nhs-blue">Antidepressant (AD) Guidance</h3>
                <p class="text-sm mt-1 text-nhs-grey">Switching and stopping ADs based on NICE/SPS principles.</p>
            </button>

            <!-- 2. Prescription Drug Tapering Module (New) -->
            <button onclick="showModule('tapering-abuse-guidance')" class="p-4 bg-yellow-100 hover:bg-yellow-200 transition rounded-lg text-left border border-yellow-400/50 shadow-md">
                <h3 class="font-bold text-lg text-nhs-grey">Prescription Drug Tapering</h3>
                <p class="text-sm mt-1 text-nhs-grey">Guidance for Codeine, Zopiclone, Tramadol, Morphine, and Benzodiazepines.</p>
            </button>

            <!-- 3. Opiate Conversion Module (New) -->
            <button onclick="showModule('opiate-conversion-guidance')" class="p-4 bg-red-100 hover:bg-red-200 transition rounded-lg text-left border border-red-400/50 shadow-md">
                <h3 class="font-bold text-lg text-nhs-grey">Opiate Conversion Calculator</h3>
                <p class="text-sm mt-1 text-nhs-grey">Convert multiple opiates to Morphine Equivalent Daily Dose (MEDD).</p>
            </button>
        </div>
    </section>

    <!-- MODULE CONTAINER (Hidden by default, used to switch views) -->
    <div id="module-container" class="hidden">
        <button onclick="showModule('welcome-screen')" class="mt-4 mb-4 text-nhs-blue hover:underline font-semibold flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Back to Modules
        </button>
        
        <!-- 1. AD GUIDANCE MODULE (Stubbed from original) -->
        <section id="ad-guidance" class="card hidden">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Antidepressant Guidance</h2>
            <div class="tabs flex gap-2 mb-4">
                <button class="tab-button active" data-tab="ad-switching">Switching</button>
                <button class="tab-button" data-tab="ad-stopping">Stopping / Cessation</button>
            </div>

            <div id="ad-switching" class="tab-content">
                <p class="text-sm mb-4 text-nhs-grey">The full Antidepressant Switching logic is retained from the original app structure, though simplified here for integration. Use the dropdowns to generate the switch plan.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fromDrugAD" class="block text-sm font-medium mb-1">Current Antidepressant</label>
                        <select id="fromDrugAD"></select>
                    </div>
                    <div>
                        <label for="toDrugAD" class="block text-sm font-medium mb-1">New Antidepressant</label>
                        <select id="toDrugAD"></select>
                    </div>
                </div>
                <button onclick="calculateADSwitch()" class="btn-primary mt-4 w-full">Generate Switch Plan</button>
                <div id="switchOutputAD" class="output-box hidden">
                    <h3>AD Switch Plan</h3>
                    <pre id="switchClinicianAD"></pre>
                </div>
            </div>

            <div id="ad-stopping" class="tab-content hidden">
                <p class="text-sm mb-4 text-nhs-grey">The full Antidepressant Stopping logic is retained from the original app structure, though simplified here for integration. Use the dropdown to generate the taper plan.</p>
                <div>
                    <label for="stopDrugAD" class="block text-sm font-medium mb-1">Antidepressant to Stop</label>
                    <select id="stopDrugAD"></select>
                </div>
                <button onclick="calculateADTaper()" class="btn-primary mt-4 w-full">Generate Taper Plan</button>
                <div id="stopOutputAD" class="output-box hidden">
                    <h3>AD Taper Plan</h3>
                    <pre id="stopClinicianAD"></pre>
                </div>
            </div>
        </section>


        <!-- 2. PRESCRIPTION DRUG TAPERING MODULE (New) -->
        <section id="tapering-abuse-guidance" class="card hidden">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Prescription Drug Tapering Guidance</h2>
            <p class="text-sm text-nhs-grey mb-4">
                This tool provides a sample reduction schedule based on accepted principles (e.g., slow, gradual reduction). Always consider referral to specialist substance misuse or pain teams. **These plans require highly individualised care and close monitoring.** </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="taperDrug" class="block text-sm font-medium mb-1">Drug for Reduction</label>
                    <select id="taperDrug" onchange="updateTaperDrugUnit()">
                        <option value="">Select Drug</option>
                    </select>
                </div>
                <div>
                    <label for="currentDoseTaper" class="block text-sm font-medium mb-1">Current Total Daily Dose (TDD) (<span id="taperUnit">mg</span>)</label>
                    <input type="number" id="currentDoseTaper" placeholder="e.g., 240 (for Codeine)">
                </div>
            </div>
            
            <button onclick="generateTaperSchedule()" class="btn-primary w-full">Generate Taper Schedule</button>

            <div id="taperOutput" class="output-box hidden">
                <h3>Draft Tapering Schedule</h3>
                <pre id="taperClinicianOutput"></pre>
                <p class="text-xs mt-4 italic">
                    **Reference Principles:** BNF/CKS guidelines for gradual reduction; Royal College of Psychiatrists (for Benzodiazepines/Z-Drugs conversion to Diazepam equivalent); Specialist Pain/Misuse services for complex cases. Taper is based on an approximate 10-20% dose reduction every 1-2 weeks.
                </p>
            </div>
        </section>

        <!-- 3. OPIATE CONVERSION MODULE (New) -->
        <section id="opiate-conversion-guidance" class="card hidden">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Opiate Conversion Calculator</h2>
            <p class="text-sm text-nhs-grey mb-4">
                Convert total current opiate use to a Morphine Equivalent Daily Dose (MEDD) for safe switching. Conversion ratios are based on common palliative care guidance and should be used cautiously. **A safety margin is always applied when switching.** </p>

            <div id="current-opiates-input">
                <h3 class="font-medium text-lg mb-2 text-nhs-grey">Current Opiate Usage</h3>
                <!-- Template for a single opiate entry -->
                <div id="opiate-entry-template" class="grid grid-cols-5 gap-3 mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="col-span-2">
                        <label class="block text-xs font-medium mb-1">Opiate</label>
                        <select class="opiate-drug-select"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Dose</label>
                        <input type="number" class="opiate-dose-input" placeholder="Dose">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Units</label>
                        <input type="text" class="opiate-unit-display" readonly>
                    </div>
                    <div class="flex items-end justify-center">
                        <!-- Use window.removeOpiateEntry for direct onclick access -->
                        <button onclick="window.removeOpiateEntry(this)" class="p-2 text-red-600 hover:text-red-800 transition rounded-full" title="Remove">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <button onclick="addOpiateEntry()" class="text-sm text-nhs-blue hover:underline font-medium mt-2 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Add another Opiate
            </button>
            
            <hr class="my-6 border-gray-300">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="targetOpiate" class="block text-sm font-medium mb-1">Target Opiate for Switch</label>
                    <select id="targetOpiate"></select>
                </div>
                <div>
                    <label for="safetyMargin" class="block text-sm font-medium mb-1">Cross-Tolerance Safety Margin</label>
                    <select id="safetyMargin">
                        <option value="0.75" selected>25% Reduction (Standard)</option>
                        <option value="0.5">50% Reduction (High Risk/Elderly)</option>
                        <option value="1">0% Reduction (Avoid)</option>
                    </select>
                </div>
            </div>

            <button onclick="calculateOpiateConversion()" class="btn-primary w-full">Calculate Conversion</button>

            <div id="conversionOutput" class="output-box hidden">
                <h3>Opiate Conversion Results</h3>
                <p class="text-sm mb-2 font-semibold">Total Current MEDD: <span id="totalMEDD" class="font-bold text-red-600">0 mg</span></p>
                
                <h4 class="font-semibold mt-4 text-nhs-blue">Equivalent Target Opiate Dose</h4>
                <pre id="targetDoseOutput" class="text-sm"></pre>

                <h4 class="font-semibold mt-4 text-nhs-blue">Breakthrough (PRN) Medication Plan (1/6th of TDD)</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div>
                        <label for="prnFormulation" class="block text-xs font-medium mb-1">PRN Formulation</label>
                        <select id="prnFormulation" onchange="updatePrnDose()"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">PRN Dose</label>
                        <input type="text" id="prnDoseOutput" readonly class="bg-white">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <span id="prnUnitDisplay" class="text-sm font-medium p-2"></span>
                    </div>
                </div>

                <p class="text-xs mt-4 italic">
                    **Reference Principles:** Equivalent doses from BNF/Palliative Care Guidelines (e.g., NICE CKS Palliative Care). The standard breakthrough dose is 1/6th of the total daily dose (TDD) of the new opiate.
                </p>
            </div>

        </section>

    </div>

</main>

<script type="module">
    // --- FIREBASE AND ENVIRONMENT SETUP (MANDATORY FOR CANVAS) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId;

    if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // Fetch user data or start listeners here if needed after auth
            } else {
                // If not signed in (shouldn't happen with custom token flow), sign in anonymously
                signInAnonymously(auth).then(userCredential => {
                    userId = userCredential.user.uid;
                }).catch(error => console.error("Anonymous sign in failed:", error));
            }
        });

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken)
                .catch(error => console.error("Custom token sign in failed:", error));
        } else {
             // Fallback to anonymous sign-in if token is missing
             signInAnonymously(auth).catch(error => console.error("Anonymous sign in failed:", error));
        }
    } else {
        console.warn("Firebase config not available. Database features are disabled.");
    }

    // --- CORE DATA STRUCTURES ---

    // 1. Antidepressant Data (Simplified for demonstration)
    const adData = [
        { name: "Citalopram", group: "SSRI", taper: "Reduce by 10mg every 2 weeks." },
        { name: "Sertraline", group: "SSRI", taper: "Reduce by 50mg every 2-4 weeks." },
        { name: "Venlafaxine", group: "SNRI", taper: "Requires slow taper, switching to modified release or using immediate release to titrate down slowly is often advised. Refer to SPS." },
        { name: "Mirtazapine", group: "NaSSA", taper: "Reduce by 15mg every 2 weeks. Can be stopped at 15mg." },
        { name: "Fluoxetine", group: "SSRI", taper: "Can often be stopped directly due to long half-life, but a slow taper of 10mg weekly can be used." }
    ];

    const adSwitchRules = (fromGroup, toGroup) => {
        if (fromGroup === "SSRI" && toGroup === "SSRI") return "Taper the 'from' drug slowly (e.g., 2-4 weeks). Switch directly to the 'to' drug at the usual starting dose.";
        if (fromGroup === "SNRI" || toGroup === "SNRI") return "High risk. Taper 'from' drug slowly over 4 weeks. Stop, then commence 'to' drug at low dose after a wash-out (1-7 days depending on drugs). Specialist advice required.";
        return "High complexity. Always refer to full SPS guidance. Typically involves slow taper, washout, and starting new drug at low dose.";
    };


    // 2. Tapering/Abuse Drugs Data (New Module)
    const taperingDrugs = [
        { name: "Codeine", units: "mg", taperingNotes: "Start with 10% reduction per week, adjusting based on withdrawal symptoms. If dose > 240mg/day, seek specialist pain/misuse advice. Max reduction 20% of TDD every 1-2 weeks." },
        { name: "Tramadol", units: "mg", taperingNotes: "Reduce by 10-20% weekly. Max reduction 20% total daily dose every 1-2 weeks. Monitor for seizure risk." },
        { name: "Morphine (MST/Oramorph)", units: "mg", taperingNotes: "Reduce by 10-20% every 1-2 weeks. Close monitoring essential. Convert to immediate release preparation if stopping. Specialist pain/misuse advice recommended." },
        { name: "Zopiclone (and other Z-Drugs)", units: "mg", taperingNotes: "Switch to equivalent dose of long-acting benzodiazepine (e.g., Diazepam) then taper. Reduce by 0.5-1mg Diazepam equivalent every 1-2 weeks. Refer to CKS/BMA guidelines." },
        { name: "Benzodiazepines (e.g., Diazepam)", units: "mg", taperingNotes: "Convert to Diazepam equivalent, then reduce by 1-2mg every 1-2 weeks. Very slow tapering over months may be required. Refer to Yellow Card/CKS guidelines." }
    ];

    // 3. Opiate Conversion Factors (New Module)
    // Factor: Drug dose * Factor = Oral Morphine Equivalent (MME)
    const opiateConversionFactors = {
        "Oral Morphine (IR/MR)": { factor: 1, units: "mg" },
        "Oxycodone (IR/MR)": { factor: 1.5, units: "mg" }, // Using 1.5 for caution.
        "Fentanyl Patch": { factor: 2.4, units: "mcg/hr" }, // e.g., 25mcg/hr * 2.4 = 60mg MME/day
        "Hydromorphone (Oral)": { factor: 5, units: "mg" },
        "Codeine": { factor: 0.1, units: "mg" }, // 10:1 ratio.
        "Subcutaneous Morphine": { factor: 3, units: "mg" }, // 3:1 (Oral:SC)
        "Oral Methadone": { factor: 4, units: "mg" }, // Highly variable/complex. Use only for specialist guidance.
    };

    const prnOptions = [
        { name: "Oral Morphine Solution (Oramorph)", units: "mg", factor: 1 },
        { name: "Codeine Tablets", units: "mg", factor: 0.1 },
        { name: "Subcutaneous Morphine", units: "mg", factor: 3 }
    ];

    // --- APPLICATION STATE AND VIEW MANAGEMENT ---
    let activeModule = 'welcome-screen';

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.showModule = (moduleId) => {
        activeModule = moduleId;
        const modules = document.querySelectorAll('section');
        modules.forEach(mod => mod.classList.add('hidden'));

        document.getElementById('welcome-screen').classList.toggle('hidden', moduleId !== 'welcome-screen');
        document.getElementById('module-container').classList.toggle('hidden', moduleId === 'welcome-screen');
        
        if (moduleId !== 'welcome-screen') {
            document.getElementById(moduleId).classList.remove('hidden');
        }
        
        // Ensure only one tab is shown in the AD module initially
        if (moduleId === 'ad-guidance') {
            const activeTab = document.querySelector('#ad-guidance .tab-button.active');
            const defaultTabContent = document.getElementById('ad-switching');

            // Hide all contents first
            document.querySelectorAll('#ad-guidance .tab-content').forEach(content => content.classList.add('hidden'));

            if (activeTab) {
                 // Show the currently active tab content
                document.getElementById(activeTab.dataset.tab).classList.remove('hidden');
            } else if (defaultTabContent) {
                // Default to switching tab
                defaultTabContent.classList.remove('hidden');
                document.querySelector('[data-tab="ad-switching"]').classList.add('active');
            }
        }
    };

    const setupADTabs = () => {
        const adTabs = document.querySelectorAll('#ad-guidance .tab-button');
        const adContents = document.querySelectorAll('#ad-guidance .tab-content');

        adTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                adTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                adContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(tabId).classList.remove('hidden');
            });
        });
    };

    // --- MODULE 1: ANTIDEPRESSANT LOGIC (Simplified Stubs) ---

    const populateADSelects = () => {
        const fromDrugAD = document.getElementById('fromDrugAD');
        const toDrugAD = document.getElementById('toDrugAD');
        const stopDrugAD = document.getElementById('stopDrugAD');

        [fromDrugAD, toDrugAD, stopDrugAD].forEach(select => {
            select.innerHTML = '<option value="">Select Antidepressant</option>';
            adData.forEach(drug => {
                const option = document.createElement('option');
                option.value = drug.name;
                option.textContent = `${drug.name} (${drug.group})`;
                option.dataset.group = drug.group;
                option.dataset.taper = drug.taper;
                select.appendChild(option);
            });
        });
    };

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.calculateADSwitch = () => {
        const fromSelect = document.getElementById('fromDrugAD');
        const toSelect = document.getElementById('toDrugAD');
        const fromDrug = fromSelect.value;
        const toDrug = toSelect.value;

        if (!fromDrug || !toDrug) {
            document.getElementById('switchClinicianAD').textContent = "Please select both a current and a new antidepressant.";
            document.getElementById('switchOutputAD').classList.remove('hidden');
            return;
        }

        const fromGroup = fromSelect.options[fromSelect.selectedIndex].dataset.group;
        const toGroup = toSelect.options[toSelect.selectedIndex].dataset.group;
        const rule = adSwitchRules(fromGroup, toGroup);

        const output = `Switching from ${fromDrug} (${fromGroup}) to ${toDrug} (${toGroup}):\n\nGUIDANCE:\n${rule}\n\nACTION:\n- Taper ${fromDrug} slowly.\n- Follow washout period and start ${toDrug} at the recommended starting dose.\n\nALWAYS refer to the full SPS Monograph for definitive guidance.`;
        document.getElementById('switchClinicianAD').textContent = output;
        document.getElementById('switchOutputAD').classList.remove('hidden');
    };

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.calculateADTaper = () => {
        const stopSelect = document.getElementById('stopDrugAD');
        const stopDrug = stopSelect.value;

        if (!stopDrug) {
            document.getElementById('stopClinicianAD').textContent = "Please select an antidepressant to stop.";
            document.getElementById('stopOutputAD').classList.remove('hidden');
            return;
        }

        const taperPlan = stopSelect.options[stopSelect.selectedIndex].dataset.taper;

        const output = `Stopping ${stopDrug}:\n\nPLAN:\n- ${taperPlan}\n- Tapering should be symptom-guided and may need to be slower than this guide.\n- Monitor for discontinuation symptoms for at least 4 weeks post-cessation.\n\nALWAYS refer to the full NICE/SPS guidance.`;
        document.getElementById('stopClinicianAD').textContent = output;
        document.getElementById('stopOutputAD').classList.remove('hidden');
    };


    // --- MODULE 2: TAPERING/ABUSE DRUG LOGIC ---

    const populateTaperDrugSelect = () => {
        const select = document.getElementById('taperDrug');
        taperingDrugs.forEach(drug => {
            const option = document.createElement('option');
            option.value = drug.name;
            option.textContent = drug.name;
            option.dataset.units = drug.units;
            option.dataset.notes = drug.taperingNotes;
            select.appendChild(option);
        });
    };

    // EXPOSE TO WINDOW FOR ONCHANGE ACCESS
    window.updateTaperDrugUnit = () => {
        const select = document.getElementById('taperDrug');
        const unitDisplay = document.getElementById('taperUnit');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption && selectedOption.dataset.units) {
            unitDisplay.textContent = selectedOption.dataset.units;
        } else {
            unitDisplay.textContent = 'mg';
        }
        document.getElementById('taperOutput').classList.add('hidden');
    };

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.generateTaperSchedule = () => {
        const drugSelect = document.getElementById('taperDrug');
        const doseInput = document.getElementById('currentDoseTaper');
        const drugName = drugSelect.value;
        const currentDose = parseFloat(doseInput.value);
        const outputElement = document.getElementById('taperClinicianOutput');
        const notes = drugSelect.options[drugSelect.selectedIndex]?.dataset.notes || "No specific guidance found. Taper very slowly (5-10% of TDD every 1-4 weeks).";
        const unit = document.getElementById('taperUnit').textContent;

        document.getElementById('taperOutput').classList.remove('hidden');
        outputElement.textContent = '';

        if (!drugName || isNaN(currentDose) || currentDose <= 0) {
            outputElement.textContent = "Please select a drug and enter a valid total daily dose.";
            return;
        }
        
        // Simple 15% reduction per 2 weeks (4 stages = 8 weeks)
        let taperSchedule = `**Tapering ${drugName} - Starting Dose: ${currentDose} ${unit} TDD**\n\n`;
        taperSchedule += `GENERAL PRINCIPLES:\n- ${notes}\n- Tapering should be symptom-guided, and the rate must be slowed if withdrawal is severe.\n\n`;
        taperSchedule += `| Week | Target Dose | Reduction Rate |\n`;
        taperSchedule += `|:----:|:-----------:|:--------------:|\n`;
        
        let dose = currentDose;
        const stages = 4; // Illustrative 4 stages of reduction
        const reductionRate = 0.15; // Target ~15% reduction per stage

        for (let i = 1; i <= stages; i++) {
            const reductionAmount = currentDose * reductionRate;
            dose = Math.max(0, currentDose - (reductionAmount * i));
            
            // Round dose to nearest whole number or 0.5 for typical tablet sizes
            const roundedDose = Math.round(dose * 2) / 2;
            const weekStart = (i * 2) - 1;
            const weekEnd = i * 2;


            taperSchedule += `| ${weekStart}-${weekEnd} | ${roundedDose.toFixed(1)} ${unit} | ${i === 1 ? '15% Reduction' : 'Next 15% Reduction'} |\n`;
        }
        
        const finalDose = Math.round(dose * 2) / 2;
        if (finalDose > 0) {
             taperSchedule += `| ${stages * 2 + 1}-${stages * 2 + 2} | 0.0 ${unit} | Final Cessation |\n`;
        }


        // Final note for slow taper option
        taperSchedule += "\n**Note:** For long-term use or severe dependence, the taper may need to be significantly slower (e.g., 5-10% reduction every 4 weeks) over several months. Always use clinical judgement and local prescribing guidelines."
        
        outputElement.textContent = taperSchedule;
    };


    // --- MODULE 3: OPIATE CONVERSION LOGIC ---

    let opiateEntryCounter = 0;

    const populateOpiateSelects = () => {
        const currentOpiateSelects = document.querySelectorAll('.opiate-drug-select');
        const targetOpiateSelect = document.getElementById('targetOpiate');
        const prnFormulationSelect = document.getElementById('prnFormulation');
        
        const opiateNames = Object.keys(opiateConversionFactors);

        // Populate current opiate selects
        currentOpiateSelects.forEach(select => {
            // Check if the select is empty before populating (to avoid re-populating on add)
            if (select.options.length <= 1) { 
                select.innerHTML = '<option value="">Select Opiate</option>';
                opiateNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
                select.onchange = updateOpiateEntryUnits;
            }
        });

        // Populate target opiate select
        targetOpiateSelect.innerHTML = '<option value="">Select Target Opiate</option>';
        opiateNames.filter(name => !name.includes('Subcutaneous')).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            targetOpiateSelect.appendChild(option);
        });

        // Populate PRN formulation select
        prnFormulationSelect.innerHTML = '';
        prnOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.name;
            option.textContent = `${opt.name} (${opt.units})`;
            prnFormulationSelect.appendChild(option);
        });
    };

    const updateOpiateEntryUnits = (event) => {
        const select = event.target;
        const drugName = select.value;
        const parent = select.closest('.grid');
        const unitDisplay = parent.querySelector('.opiate-unit-display');
        
        if (drugName && opiateConversionFactors[drugName]) {
            unitDisplay.value = opiateConversionFactors[drugName].units;
        } else {
            unitDisplay.value = '';
        }
        document.getElementById('conversionOutput').classList.add('hidden');
    };

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.addOpiateEntry = () => {
        opiateEntryCounter++;
        const container = document.getElementById('current-opiates-input');
        const template = document.getElementById('opiate-entry-template');
        const newEntry = template.cloneNode(true);
        
        newEntry.id = `opiate-entry-${opiateEntryCounter}`;
        newEntry.classList.remove('hidden');

        // Reset inputs and update classes
        const select = newEntry.querySelector('.opiate-drug-select');
        const input = newEntry.querySelector('.opiate-dose-input');
        const unit = newEntry.querySelector('.opiate-unit-display');
        const removeBtn = newEntry.querySelector('button');

        select.name = `opiate-drug-${opiateEntryCounter}`;
        input.name = `opiate-dose-${opiateEntryCounter}`;
        
        // Attach event listeners to the new elements
        select.onchange = updateOpiateEntryUnits;
        input.oninput = () => document.getElementById('conversionOutput').classList.add('hidden');
        // Ensure the remove function is correctly referenced in the cloned node's button
        removeBtn.setAttribute('onclick', `window.removeOpiateEntry(this)`);


        // Repopulate select options only for the new select
        select.innerHTML = '<option value="">Select Opiate</option>';
        Object.keys(opiateConversionFactors).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });
        select.onchange = updateOpiateEntryUnits;

        // Reset values
        select.value = "";
        input.value = "";
        unit.value = "";


        container.appendChild(newEntry);
    };

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.removeOpiateEntry = (button) => {
        const entry = button.closest('.grid');
        // Prevent removing the template itself
        if (entry.id !== 'opiate-entry-template') {
            entry.remove();
            document.getElementById('conversionOutput').classList.add('hidden');
        }
    };

    // EXPOSE TO WINDOW FOR ONCLICK ACCESS
    window.calculateOpiateConversion = () => {
        const entries = document.querySelectorAll('#current-opiates-input > div:not([id="opiate-entry-template"])');
        const targetOpiate = document.getElementById('targetOpiate').value;
        const safetyMarginFactor = parseFloat(document.getElementById('safetyMargin').value);
        let totalMEDD = 0;

        document.getElementById('conversionOutput').classList.remove('hidden');
        document.getElementById('targetDoseOutput').textContent = '';
        document.getElementById('prnDoseOutput').value = '';
        document.getElementById('prnUnitDisplay').textContent = '';
        document.getElementById('totalMEDD').textContent = '0 mg';

        if (!targetOpiate) {
            document.getElementById('targetDoseOutput').textContent = "Please select a target opiate for the switch.";
            return;
        }

        // 1. Calculate Total MEDD
        let hasValidInput = false;
        entries.forEach(entry => {
            const drugName = entry.querySelector('.opiate-drug-select').value;
            const dose = parseFloat(entry.querySelector('.opiate-dose-input').value);

            if (drugName && !isNaN(dose) && dose > 0) {
                hasValidInput = true;
                const factor = opiateConversionFactors[drugName]?.factor;
                if (factor) {
                    // Total MEDD (Oral Morphine Equivalent) = Dose * Factor
                    totalMEDD += dose * factor;
                } else {
                    console.error(`Missing conversion factor for ${drugName}`);
                }
            }
        });

        if (!hasValidInput) {
            document.getElementById('targetDoseOutput').textContent = "Please enter valid doses for at least one current opiate to calculate MEDD.";
            document.getElementById('totalMEDD').textContent = '0 mg';
            return;
        }

        document.getElementById('totalMEDD').textContent = `${totalMEDD.toFixed(1)} mg`;

        // 2. Calculate Target Opiate Dose
        const targetFactor = opiateConversionFactors[targetOpiate]?.factor;
        const targetUnits = opiateConversionFactors[targetOpiate]?.units;
        
        if (!targetFactor) {
            document.getElementById('targetDoseOutput').textContent = "Error: Target opiate conversion factor not found.";
            return;
        }

        // Target TDD = (Total MEDD * Safety Margin) / Target Drug Factor 
        const adjustedMEDD = totalMEDD * safetyMarginFactor;
        const targetTDD = adjustedMEDD / targetFactor;

        let output = `**Target Opiate (Switch):** ${targetOpiate}\n`;
        output += `Safety Margin Applied: ${((1 - safetyMarginFactor) * 100).toFixed(0)}% reduction.\n\n`;
        output += `NEW Total Daily Dose (TDD):\n- ${targetTDD.toFixed(1)} ${targetUnits} of ${targetOpiate}\n\n`;
        output += `**Clinical Advice:** Consider slow release for maintenance and immediate release for PRN.\n**Titration:** Start the new TDD slowly, increasing over days if pain control is inadequate.`;
        
        document.getElementById('targetDoseOutput').textContent = output;

        // 3. Calculate Breakthrough Dose (PRN)
        const prnDoseBase = targetTDD / 6; // Standard 1/6th of TDD for PRN
        document.getElementById('prnDoseOutput').dataset.prnDose = prnDoseBase; // Store the calculated dose
        updatePrnDose();

    };

    // EXPOSE TO WINDOW FOR ONCHANGE ACCESS
    window.updatePrnDose = () => {
        const prnSelect = document.getElementById('prnFormulation');
        // Retrieve the base MEDD equivalent PRN dose
        const prnDoseBase = parseFloat(document.getElementById('prnDoseOutput').dataset.prnDose || 0);
        const selectedPrn = prnOptions.find(opt => opt.name === prnSelect.value);

        if (prnDoseBase > 0 && selectedPrn) {
            // PRN Dose = (Base PRN MEDD) / (PRN Drug's Factor)
            const finalPrnDose = prnDoseBase / selectedPrn.factor;
            
            // Round to sensible tablet/solution increments (nearest 2.5mg or 5mg)
            let roundedDose;
            if (finalPrnDose < 5) {
                roundedDose = Math.round(finalPrnDose * 4) / 4; // nearest 0.25
            } else if (finalPrnDose < 20) {
                roundedDose = Math.round(finalPrnDose * 2) / 2; // nearest 0.5
            } else {
                roundedDose = Math.round(finalPrnDose / 5) * 5; // nearest 5mg
            }

            document.getElementById('prnDoseOutput').value = roundedDose.toFixed(1);
            document.getElementById('prnUnitDisplay').textContent = selectedPrn.units;

        } else {
            document.getElementById('prnDoseOutput').value = 'N/A';
            document.getElementById('prnUnitDisplay').textContent = '';
        }
    };


    // --- INITIALISATION ---

    // Add a single starting row for the opiate conversion module outside of the onload function
    // to ensure it is available when the DOM is parsed.
    window.onload = () => {
        // Initial setup for the two new modules
        populateTaperDrugSelect();
        populateADSelects();

        // Initial opiate entry for the conversion module (must be called after selects are populated)
        // Check if an entry already exists (only the template should exist initially)
        if (document.querySelectorAll('#current-opiates-input > div:not([id="opiate-entry-template"])').length === 0) {
            window.addOpiateEntry(); 
        }

        // Setup AD module tabs
        setupADTabs();

        // Start on the welcome screen
        window.showModule('welcome-screen');
    };
</script>

</body>
</html>
